
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BusinessFlow V3.8 - 業務工作流系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { 
            --orange-primary: #FF6E25;
            --orange-glow: rgba(255, 110, 37, 0.5);
            --egypt-blue: #1633A8;
            --egypt-blue-glow: rgba(22, 51, 168, 0.5);
            --text-light-blue: #A1B0F6;
            --bg-dark: #151515;
            --bg-hover: #2a2a2a;
            --header-bg: #202020;
            --deep-blue-solid: #151A28;
        }
        
        body { 
            background: linear-gradient(135deg, #1a1a1a 0%, #050505 100%);
            color: #e0e0e0; height: 100vh; overflow: hidden;
            font-family: 'Arial', sans-serif;
            user-select: none;
        }

        /* 側邊欄 */
        .sidebar { 
            background-color: rgba(22, 51, 168, 0.25);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            transition: width 0.3s ease; width: 240px;
        }

        /* User Profile Section - Final Mix */
        .user-profile-section {
            padding: 20px 10px 15px 10px; /* 恢復稍微寬鬆的 padding */
            display: flex; flex-direction: column; align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(180deg, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0) 100%);
            transition: all 0.3s ease;
        }
        .user-avatar-container {
            /* 恢復大尺寸 80px */
            position: relative; width: 80px; height: 80px;
            margin-bottom: 10px; transition: all 0.3s ease;
            cursor: pointer;
        }
        .user-avatar {
            width: 100%; height: 100%; object-fit: cover;
            border-radius: 50%;
            border: 3px solid var(--orange-primary); /* 恢復較粗邊框 */
            box-shadow: 0 0 15px var(--orange-glow); /* 恢復較強光暈 */
            transition: all 0.3s ease;
        }
        .user-avatar:hover { transform: scale(1.05); filter: brightness(1.1); }
        .user-info {
            width: 100%; text-align: center;
            transition: opacity 0.2s ease, height 0.3s ease;
            opacity: 1; height: auto; overflow: hidden;
            display: flex; flex-direction: column; gap: 6px; /* 增加間距 */
        }
        .user-name-input {
            background: transparent; border: none; border-bottom: 1px solid rgba(255,255,255,0.05);
            /* 恢復大字體 1.2rem */
            color: white; font-size: 1.2rem; font-weight: bold; text-align: center;
            width: 100%; outline: none; padding-bottom: 4px; margin-bottom: 4px;
        }
        .user-name-input:focus { border-bottom-color: var(--orange-primary); }
        
        /* 整合式外框容器 (保留喜歡的設計) */
        .profile-combo-box {
            display: flex; align-items: center;
            background-color: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px;
            margin-top: 2px;
            height: 28px;
        }
        .profile-combo-box:hover { border-color: rgba(255,255,255,0.2); }

        .profile-selector {
            flex: 1; 
            background: transparent; border: none; 
            color: #aaa; font-size: 0.8rem; 
            padding: 0 0 0 8px; height: 100%;
            outline: none; cursor: pointer; width: 0;
        }
        .profile-selector option { background: #151515; color: #ccc; }
        
        .profile-actions-inline {
            display: flex; gap: 10px; align-items: center;
            padding: 0 10px;
            height: 16px;
            border-left: 1px solid rgba(255,255,255,0.1); 
            margin-left: 2px;
        }
        .profile-btn-icon { font-size: 0.8rem; cursor: pointer; opacity: 0.6; transition: all 0.2s; }
        .profile-btn-icon:hover { opacity: 1; transform: scale(1.1); }

        /* Sidebar Collapsed State */
        .sidebar.collapsed .user-profile-section { padding: 15px 0; }
        .sidebar.collapsed .user-avatar-container { width: 40px; height: 40px; margin-bottom: 0; }
        .sidebar.collapsed .user-avatar { border-width: 2px; box-shadow: none; }
        .sidebar.collapsed .user-info { opacity: 0; height: 0; margin: 0; pointer-events: none; }
        .sidebar.collapsed { width: 70px;
        }
        .sidebar.collapsed .menu-text, .sidebar.collapsed .logo-text, .sidebar.collapsed .submenu-icon { display: none;
        }

        /* 表格容器 */
        .table-container { height: calc(100vh - 140px);
            overflow: auto; position: relative; }
        
        /* 表格列樣式 */
        .table-row { cursor: pointer;
            transition: background-color 0.2s; }
        .table-row:hover td { background-color: var(--bg-hover) !important;
        }
        .table-row:hover .sticky-col { background-color: var(--bg-hover) !important;
        }
        .select-mode .table-row:hover td, .select-mode .table-row:hover .sticky-col { background-color: #1a2a50 !important;
        }

        table { border-collapse: separate; border-spacing: 0; min-width: 100%; table-layout: fixed;
        }
        
        th { 
            background-color: var(--header-bg);
            position: sticky; top: 0; z-index: 40;
            padding: 12px 10px; text-align: left; 
            font-size: 0.8rem; color: #aaa; letter-spacing: 1px; font-weight: 600;
            /* 修正：移除 border-bottom，改用 ::after 偽元素繪製底線，解決 Sticky 狀態下線條斷裂問題 */
            /* border-bottom: 2px solid var(--orange-primary); */
            box-shadow: 0 2px 5px rgba(0,0,0,0.5); white-space: nowrap;
            border-right: none;
        }
        /* 新增：透過偽元素繪製穩定的橘色表頭底線 */
        th::after {
            content: ''; position: absolute; left: 0; bottom: 0;
            width: 100%; height: 2px; background-color: var(--orange-primary);
            z-index: 45;
        }
        td { 
            padding: 0;
            border-bottom: 1px solid #333; 
            border-right: none !important;
            vertical-align: middle;
            font-size: 0.9rem; color: #e0e0e0;
            background-color: var(--bg-dark);
            height: 45px;
        }

        .cell-content {
            padding: 8px 10px;
            height: 45px; display: flex; align-items: center;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            cursor: pointer; width: 100%;
        }
        .cell-content:hover { color: white;
        }

        /* 凍結窗格設定 */
        .sticky-col { 
            position: sticky !important;
            z-index: 20;
            background-color: var(--bg-dark);
            border-right: none !important;
            box-shadow: 1px 0 0 #333;
        }
        .sticky-right {
            position: sticky !important;
            right: 0; z-index: 25;
            background-color: var(--bg-dark);
            box-shadow: -1px 0 0 #333;
            border-left: 1px solid #333;
        }
        th.sticky-col, th.sticky-right { background-color: var(--header-bg); z-index: 50;
        }

        /* 最新動態底色實心深藍 */
        .col-latest { background-color: var(--deep-blue-solid) !important;
        }
        .table-row:hover .col-latest { background-color: var(--bg-hover) !important;
        }

        /* 凍結欄位位置計算 */
        body:not(.select-mode) .col-0 { left: 0px;
        }
        
        /* 左方功能區展開時，Project 欄(col-1)隱藏 */
        body:not(.sidebar-collapsed) .col-1 { display: none;
        }
        body.sidebar-collapsed .col-1 { display: table-cell;
        }
        /* 當 Project 顯示時的位置 */
        body.sidebar-collapsed:not(.select-mode) .col-1 { left: 40px;
        }
        
        /* Sidebar Open (Project Hidden) */
        body:not(.sidebar-collapsed):not(.select-mode) .col-2 { left: 40px;
        } 
        body:not(.sidebar-collapsed):not(.select-mode) .col-3 { left: 120px;
        }
        body:not(.sidebar-collapsed):not(.select-mode) .col-4 { left: 200px;
        }
        body:not(.sidebar-collapsed):not(.select-mode) .col-5 { left: 260px;
        }
        body:not(.sidebar-collapsed):not(.select-mode) .col-6 { left: 410px;
        /* 修正: Model 加寬 50px */
        }

        /* Sidebar Closed (Project Shown) */
        body.sidebar-collapsed:not(.select-mode) .col-2 { left: 120px;
        } 
        body.sidebar-collapsed:not(.select-mode) .col-3 { left: 200px;
        }
        body.sidebar-collapsed:not(.select-mode) .col-4 { left: 280px;
        }
        body.sidebar-collapsed:not(.select-mode) .col-5 { left: 340px;
        }
        body.sidebar-collapsed:not(.select-mode) .col-6 { left: 490px;
        /* 修正: Model 加寬 50px */
        }

        /* 選取模式下的調整 */
        .select-mode .col-check { left: 0px;
            z-index: 30; }
        body.sidebar-collapsed.select-mode .col-0 { left: 40px;
        }
        body:not(.sidebar-collapsed).select-mode .col-0 { left: 40px;
        }

        .text-model { color: var(--text-light-blue) !important; font-weight: 500;
        }
        .text-small-gray { font-size: 10px; color: #9ca3af;
        }

        .btn-orange { background-color: var(--orange-primary); transition: all 0.2s; color: white;
        }
        .btn-orange:hover { background-color: #e05d1d; box-shadow: 0 0 15px var(--orange-glow); transform: translateY(-1px);
        }
        
        .input-dark { 
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1); color: white; 
            border-radius: 4px; padding: 8px 12px; width: 100%; transition: border-color 0.3s;
        }
        .input-dark:focus { outline: none; border-color: var(--orange-primary);
        }
        .input-dark option { background-color: #000; color: #fff;
        }

        /* Date Segment Input Style */
        .date-segment-container {
            display: flex;
            align-items: center; gap: 4px;
            background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px; padding: 4px 8px; width: 100%;
        }
        .date-segment-container input {
            background: transparent;
            border: none; color: white; text-align: center;
            padding: 4px 0; outline: none;
        }
        .date-segment-container input:focus { border-bottom: 1px solid var(--orange-primary);
        }
        /* Remove number spinner */
        .date-segment-container input::-webkit-outer-spin-button,
        .date-segment-container input::-webkit-inner-spin-button { -webkit-appearance: none;
            margin: 0; }

        .fab-btn {
            position: fixed;
            bottom: 10px; right: 20px;
            width: 60px; height: 60px; border-radius: 50%;
            background: var(--egypt-blue); color: white;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 20px var(--egypt-blue-glow);
            cursor: pointer; transition: all 0.3s; z-index: 100; font-size: 24px;
        }
        .fab-btn:hover { 
            transform: scale(1.1) rotate(90deg);
            background-color: #fff; 
            color: var(--orange-primary); box-shadow: 0 0 20px var(--orange-glow);
        }

        ::-webkit-scrollbar { width: 8px;
            height: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a;
        }
        ::-webkit-scrollbar-thumb { background: var(--orange-primary); border-radius: 4px;
        }

        /* Tooltip & Comment Triangle */
        .has-comment { position: relative;
        }
        .has-comment::after {
            content: '';
            position: absolute; top: 0; right: 0;
            border-left: 6px solid transparent; border-bottom: 6px solid transparent;
            border-top: 6px solid #d4af37;
            border-right: 6px solid #d4af37;
            pointer-events: auto; cursor: pointer;
        }
        
        .tag-badge { padding: 2px 6px;
            border-radius: 3px; font-size: 0.7rem; border: 1px solid rgba(255,255,255,0.2); display: inline-block; margin: 1px;
        }
        .tag-blue { background-color: rgba(22, 51, 168, 0.4); color: #A1B0F6;
        }

        .checkbox-group label { display: inline-flex; align-items: center; margin-right: 12px; margin-bottom: 6px;
            cursor: pointer; font-size: 0.9rem; color: #ccc; }
        .checkbox-group input { margin-right: 6px;
            accent-color: var(--orange-primary); }

        /* 自動建議列表樣式 */
        .suggestion-list {
            position: absolute; background: #222; border: 1px solid #444;
            max-height: 200px; overflow-y: auto; z-index: 1000; width: 100%;
            border-radius: 0 0 4px 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .suggestion-item { padding: 8px 12px; cursor: pointer; color: #ccc; font-size: 0.9rem; }
        .suggestion-item:hover { background-color: var(--orange-primary); color: white; }

        /* 浮動視窗容器 (隱形外殼) - V3.5.74 z-index 9999 */
        .float-container {
            position: fixed; z-index: 9999; display: none;
            flex-direction: column; gap: 4px;
            pointer-events: none; 
            max-width: 512px;
        }

        /* 通用 Box 樣式 */
        .float-box {
            padding: 10px 12px; border-radius: 6px;
            font-size: 0.9rem; white-space: pre-wrap; word-break: break-all;
            pointer-events: auto; /* 恢復滑鼠互動 */
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            line-height: 1.5;
        }

        /* 內容樣式 (橘框灰底) */
        .float-content-box { 
            background-color: #222;
            border: 1px solid rgba(255, 110, 37, 0.5);
            color: #e5e7eb;
        }

        /* 註解樣式 (藍框藍底) */
        .float-comment-box { 
            background-color: var(--deep-blue-solid);
            border: 1px solid #4a5568;
            color: #A1B0F6;
        }

        .toast-msg {
            position: fixed;
            bottom: 100px; left: 50%; transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.9); color: #000;
            padding: 8px 16px; border-radius: 20px; font-weight: bold;
            font-size: 0.9rem;
            z-index: 300; opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }
        .toast-show { opacity: 1;
        }

        /* 專用 Action Toast */
        .action-toast {
            position: fixed;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: rgba(20, 20, 20, 0.95); border: 1px solid var(--orange-primary);
            padding: 20px 40px;
            border-radius: 12px; z-index: 500;
            display: none; flex-col: column; align-items: center; text-align: center;
            box-shadow: 0 0 30px rgba(255, 110, 37, 0.3);
        }
        .action-toast h3 { font-size: 1.2rem; color: white; margin-bottom: 8px; font-weight: bold;
        }
        .action-toast p { font-size: 0.9rem; color: #bbb;
        }
        .action-toast-close { position: absolute; top: 10px; right: 15px; cursor: pointer; color: #666;
        }
        .action-toast-close:hover { color: white;
        }

        /* 按鈕光暈特效 */
        .btn-glow-red { animation: pulse-red 1.5s infinite;
            color: #ff6b6b; text-shadow: 0 0 5px red; }
        .btn-glow-green { animation: pulse-green 1.5s infinite;
            color: #4ade80; text-shadow: 0 0 5px lime; }
        @keyframes pulse-red { 0% { opacity: 1;
        } 50% { opacity: 0.6; } 100% { opacity: 1;
        } }
        @keyframes pulse-green { 0% { opacity: 1;
        } 50% { opacity: 0.6; } 100% { opacity: 1;
        } }
    </style>
</head>
<body class="flex" onclick="handleGlobalClick(event)" oncontextmenu="return false;">

    <aside id="sidebar" class="sidebar flex flex-col h-screen overflow-hidden backdrop-blur-sm">
        
        <div id="userProfileSection" class="user-profile-section shrink-0">
            <div class="user-avatar-container" onclick="document.getElementById('avatarUpload').click()" title="更換頭像">
                <img id="displayAvatar" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="user-avatar" alt="User">
                <div class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-full opacity-0 hover:opacity-100 transition-opacity text-white text-xs rounded-full">
                    <i class="fas fa-camera"></i>
                </div>
            </div>
            <input type="file" id="avatarUpload" class="hidden" accept="image/*" onchange="handleAvatarUpload(event)">
            
            <div class="user-info w-full px-3">
   
                <input type="text" id="displayUserName" class="user-name-input" placeholder="User Name" 
                       onblur="handleNameChange(this.value)" 
                       onkeydown="if(event.key === 'Enter') this.blur()">
                
                <div class="profile-combo-box">
                    <select id="profileSelect" class="profile-selector" onchange="switchProfile(this.value)">
                        </select>
                    
                    <div class="profile-actions-inline">
                        <i class="fas fa-plus text-green-500 profile-btn-icon" onclick="createNewProfile()" title="新增設定檔"></i>
                        <i class="fas fa-trash-alt text-red-500 profile-btn-icon" onclick="deleteCurrentProfile()" title="刪除當前設定檔"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-4 flex items-center gap-4 h-16 border-b border-white/10 shrink-0">
            <button onclick="toggleSidebar()" class="text-white text-lg hover:text-orange-400 w-6 text-center">
                <i class="fas fa-bars"></i>
            </button>
            <span class="font-bold text-lg tracking-wider 
            italic logo-text text-orange-500">BusinessFlow <span class="text-xs bg-orange-600 text-white px-1 rounded ml-1 not-italic">V3.8</span></span>
        </div>

        <nav class="flex-1 overflow-y-auto custom-scrollbar flex flex-col mt-4">
            <div id="navMenu"></div>
            <div class="my-2 border-t border-white/10 mx-4 shrink-0"></div>
            <div>
          
                <a href="#" onclick="document.getElementById('excelImport').click()" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors">
                    <i class="fas fa-file-import w-6 text-center text-green-500"></i> <span class="menu-text">匯入 Excel</span>
                </a>
                <input type="file" id="excelImport" class="hidden" accept=".xlsx, .xls, .csv" onchange="handleExcelImport(event)">
           
                <div>
 
                    <a href="#" onclick="toggleExportMenu()" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors cursor-pointer w-full justify-between">
                        <div class="flex items-center gap-4">
                            <i class="fas fa-file-export w-6 text-center text-blue-400"></i> 
                            <span class="menu-text">匯出 Excel</span>
                        </div>
                        <i class="fas fa-chevron-down text-xs text-gray-500 submenu-icon transition-transform" id="exportArrow"></i>
                    </a>
                    <div id="exportSubmenu" 
                    class="hidden bg-black/20 border-l-2 border-blue-500/30 ml-6">
    
                    <div onclick="exportExcel('LIST')" class="p-3 pl-8 hover:bg-white/10 cursor-pointer text-sm text-gray-300"><i class="fas fa-table mr-2"></i>LIST (業務管理)</div>
   
                 <div onclick="openExportModal()" class="p-3 pl-8 hover:bg-white/10 cursor-pointer text-sm text-gray-300"><i class="fas fa-clock mr-2"></i>Daily (業務進度)</div>
                    </div>
      
                </div>
            </div>
            <div class="my-2 border-t border-white/10 mx-4 shrink-0"></div>
            <div>
                <a href="#" onclick="backupData()" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors">
         
                    <i class="fas fa-cloud-download-alt 
                    w-6 text-center text-yellow-400"></i> <span class="menu-text">備份資料 (JSON)</span>
   
                </a>
                 <a href="#" onclick="document.getElementById('jsonImport').click()" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors">
               
                    <i class="fas fa-cloud-upload-alt w-6 text-center text-yellow-400"></i> <span class="menu-text">還原資料</span>
                </a>
      
                <input type="file" id="jsonImport" class="hidden" accept=".json" onchange="restoreData(event)">
            </div>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden relative">
        <header class="h-16 border-b border-white/10 
        flex justify-between items-center px-6 bg-[#121212] shrink-0">
            <h2 id="sectionTitle" class="text-xl font-bold text-white tracking-wide">案子列表</h2>
            <div class="flex gap-4 items-center">
   
                <button id="btnAddToProj" onclick="toggleAddToProjectMode()" class="hidden text-gray-400 hover:text-white text-sm font-bold flex items-center transition-all">
                    <i class="fas fa-plus-square mr-2"></i><span>新增至案子列表</span>
                </button>

                <button id="btnExportQuote" onclick="toggleExportQuoteMode()" class="hidden text-gray-400 hover:text-white text-sm font-bold flex items-center transition-all">
                    <i class="fas fa-file-invoice-dollar mr-2"></i><span>匯出報價單 (Quotation)</span>
                </button>

                <button 
id="batchDeleteBtn" onclick="deleteSelected()" class="hidden bg-red-900/50 hover:bg-red-600 text-white px-3 
                py-1 rounded text-sm transition-colors border border-red-500/50">
                   <i class="fas fa-trash-alt mr-1"></i>刪除選取
                </button>
            
                <button id="exitSelectModeBtn" onclick="exitSelectionMode()" class="hidden text-gray-400 hover:text-white text-sm">
                    取消選取
                </button>

                 <div class="relative">
      
                    <select id="sortSelect" onchange="renderCurrentView()" class="bg-[#222] border border-gray-700 text-gray-300 text-sm rounded-full pl-3 pr-8 py-1.5 focus:outline-none focus:border-orange-500 appearance-none cursor-pointer hover:bg-[#333]">
                        <option value="date_new">活動日期 (新→舊)</option>
                        <option value="date_old">活動日期 (舊→新)</option>
                        <option value="az">字母順序 (A→Z)</option>
                        <option value="za">字母順序 (Z→A)</option>
                    </select>
                    <i class="fas fa-sort absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-xs pointer-events-none"></i>
                
                </div>

                <div class="relative">
                  
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-xs"></i>
                    <input type="text" id="searchInput" placeholder="搜尋..." onkeyup="renderCurrentView()"
                    class="bg-[#222] border border-gray-700 rounded-full pl-8 pr-8 py-1.5 text-sm focus:outline-none focus:border-orange-500 w-64 transition-all">
                    <i class="fas fa-times absolute right-3 top-1/2 
                    transform -translate-y-1/2 text-gray-500 text-xs cursor-pointer hover:text-white" onclick="clearSearch()"></i>
  
                </div>
            </div>
        </header>

        <div id="contentArea" class="flex-1 overflow-hidden p-0 bg-[#0a0a0a]">
            <div class="h-full p-4 flex flex-col">
  
                <div class="bg-[#151515] rounded-lg border border-white/5 flex-1 overflow-hidden relative shadow-xl flex flex-col">
 
                    <div class="table-container custom-scrollbar">
                        <table class="w-full text-left text-sm" id="mainTable">
   
                          
                            <thead id="tableHead"></thead>
    
                            <tbody id="tableBody"></tbody>
             
                        </table>
                        <div id="emptyState" 
                        class="hidden flex flex-col items-center justify-center py-20 text-gray-500">
              
                   
                            <i class="fas fa-folder-open text-4xl mb-4 opacity-50"></i>
                            <p>尚無資料，請點擊右下角 "+" 新增或長按列表項目進入批次模式</p>
                
                       </div>
                   
  
                  </div>
                  
                  <div class="w-full relative flex items-center justify-center py-2 shrink-0 bg-[#151515] border-t border-white/5 h-[34px]">
                      
                      <div class="absolute left-4 top-0 bottom-0 h-full flex items-center gap-4 text-lg z-10">
                          <button onclick="triggerUndo()" class="text-gray-500 hover:text-orange-400 hover:scale-110 transition-all duration-200 flex items-center" title="還原 (Ctrl+Z)">
                              <i class="fas fa-undo"></i>
                          </button>
                          <button onclick="triggerRedo()" class="text-gray-500 hover:text-orange-400 hover:scale-110 transition-all duration-200 flex items-center" title="重作 (Ctrl+Y)">
                              <i class="fas fa-redo"></i>
                          </button>
                      </div>

                      <div style="color: #E34D00; font-size: 10px; letter-spacing: 1px;" class="font-bold cursor-default">Designed by Von Van © 2026</div>
                  </div>
         
               </div>
            </div>
        </div>

        <div class="fab-btn" 
        onclick="openModal('add')">
            <i class="fas fa-plus"></i>
        </div>
    </main>

    <div id="mainModal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[100] backdrop-blur-sm" onclick="/* stop prop */">
   
         <div class="bg-[#1a1a1a] border border-orange-500/30 w-[800px] max-h-[90vh] rounded-xl shadow-2xl overflow-hidden flex flex-col" onclick="event.stopPropagation()">
 
           <div class="bg-[#202020] p-4 border-b border-white/10 flex justify-between items-center shrink-0">
              
                <h3 id="modalTitle" class="text-orange-400 font-bold text-lg"><i class="fas fa-plus-circle mr-2"></i>新增資料</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
        
            <div class="p-6 overflow-y-auto custom-scrollbar flex-1 space-y-5">
         
                <input type="hidden" id="editId">
      
                <div>
                    <label class="block text-gray-400 text-xs mb-2">資料類型</label>
                    <select id="modalType" onchange="renderModalFields()" class="input-dark font-bold 
                    text-orange-300 border-orange-500/50 bg-orange-600/20">
                   
                        <option value="projects">案子列表 (Project)</option>
                        <option value="masterList">總表維護 (Master)</option>
                      
                        <option value="tasks">任務列表 (Task)</option>
                        <option value="orders">訂單列表 (Order)</option>
                    
                        <option value="quotes">報價列表 (Quote)</option>
                       
                        <option value="contacts">聯絡人清單 (Contact)</option>
                        <option value="codes">客戶代碼與行為 (Code)</option>
                    </select>
                </div>
      
                <div id="modalFields" class="space-y-4"></div>
            
                <div class="bg-black/20 p-4 rounded border border-white/5">
                    <label class="block text-gray-400 text-xs mb-2">詳細註解 (滑鼠點擊三角形顯示)</label>
                    <div id="commentsContainer" class="space-y-2"></div>
       
                    <button onclick="addCommentField()" class="text-xs text-orange-400 
                    hover:text-white mt-2 font-bold flex items-center gap-1">
                        <i class="fas fa-plus"></i> 追加註解欄位
                    </button>
                </div>
            </div>
            <div class="p-4 bg-black/20 border-t border-white/5 flex justify-end gap-3 
            shrink-0">
                <button onclick="closeModal()" class="px-4 py-2 text-gray-400 hover:text-white text-sm">取消</button>
         
                <button onclick="saveData()" class="btn-orange px-6 py-2 rounded text-white font-bold shadow-lg">儲存變更</button>
            </div>
        </div>
    </div>

    <div id="floatContainer" class="float-container" onmouseenter="cancelFloatCloseTimer()" onmouseleave="startFloatCloseTimer()">
        <div id="floatContent" class="float-box float-content-box hidden" onmousedown="handleLongPressCopy(this)"></div>
        <div id="floatComment" class="float-box float-comment-box hidden" onmousedown="handleLongPressCopy(this)"></div>
    </div>
    <div id="toast" class="toast-msg">已複製</div>
    
    <div id="actionToast" class="action-toast">
 
        <i class="fas fa-times action-toast-close" onclick="document.getElementById('actionToast').style.display='none'"></i>
        <i class="fas fa-check-circle text-4xl text-green-500 mb-2"></i>
        <h3>已新增至案子列表</h3>
  
        <p>ˇ當年預算預設為EAU，視需要更新數值</p>
    </div>

<div id="exportModal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[700] backdrop-blur-sm" onclick="closeExportModal()">
        <div class="bg-[#202020] border border-orange-500/50 p-6 rounded-xl shadow-2xl flex flex-col gap-4 w-80" onclick="event.stopPropagation()">
            <h3 class="text-orange-400 font-bold text-lg text-center mb-2"><i class="fas fa-file-export mr-2"></i>選擇匯出範圍</h3>
            <button onclick="exportExcel('DAILY', 10); closeExportModal()" class="btn-orange px-4 py-3 rounded text-white font-bold hover:scale-105 transition-transform shadow-lg">
                <i class="fas fa-calendar-week mr-2"></i>近 10 天
            </button>
            <button onclick="exportExcel('DAILY', 'ALL'); closeExportModal()" class="bg-[#333] border border-gray-600 hover:bg-[#444] hover:text-white text-gray-300 px-4 py-3 rounded font-bold transition-colors">
                <i class="fas fa-history mr-2"></i>全部時間
            </button>
        </div>
    </div>

    <div id="quoteExportModal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[750] backdrop-blur-sm" onclick="closeQuoteExportModal()">
        <div class="bg-[#202020] border border-orange-500/50 p-6 rounded-xl shadow-2xl flex flex-col gap-4 w-[500px]" onclick="event.stopPropagation()">
            <h3 class="text-orange-400 font-bold text-lg text-center mb-2"><i class="fas fa-file-invoice-dollar mr-2"></i>匯出報價單預覽</h3>
            
            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs text-gray-500">Model</label><input id="qe_model" class="input-dark"></div>
                    <div><label class="text-xs text-gray-500">Project</label><input id="qe_project" class="input-dark"></div>
                </div>
                <div><label class="text-xs text-gray-500">業務報價 (Sales Price)</label><textarea id="qe_price" class="input-dark h-24"></textarea></div>
                <div class="grid grid-cols-3 gap-2">
                    <div><label class="text-xs text-gray-500">Date (自動帶入下個月)</label><input id="qe_date" class="input-dark"></div>
                    <div><label class="text-xs text-gray-500">Incoterm</label><input id="qe_incoterm" class="input-dark" value="FCA"></div>
                    <div><label class="text-xs text-gray-500">Country</label><input id="qe_country" class="input-dark" value="Taiwan"></div>
                </div>
                <div><label class="text-xs text-gray-500">產品結構描述 (Details)</label><textarea id="qe_struct" class="input-dark h-24"></textarea></div>
            </div>

            <div class="flex gap-3 mt-2">
                <button onclick="confirmExportQuote()" class="flex-1 btn-orange py-2 rounded text-white font-bold shadow-lg">確認匯出</button>
                <button onclick="closeQuoteExportModal()" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white py-2 rounded font-bold">取消</button>
            </div>
        </div>
    </div>

    <div id="filterMenu" class="fixed z-[600] hidden bg-[#202020] border border-orange-500/50 rounded-lg shadow-2xl flex-col w-64 max-h-[450px]" onclick="event.stopPropagation()">
        <div class="p-3 border-b border-white/10 flex justify-between items-center bg-[#252525]">
            <span class="text-orange-400 font-bold text-sm"><i class="fas fa-filter mr-2"></i>篩選與排序</span>
            <button onclick="closeFilterMenu()" class="text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
        </div>
        
        <div id="sortSection" class="p-2 border-b border-white/10 bg-[#2a2a2a] hidden">
            <label class="text-xs text-gray-400 block mb-1">此欄位排序：</label>
            <select id="filterSortSelect" onchange="applySort(this.value)" class="bg-black/40 border border-gray-600 text-gray-300 text-xs rounded w-full p-1 focus:border-orange-500 outline-none">
                <option value="">(無)</option>
            </select>
        </div>
    
        <div class="p-2 border-b border-white/10 
        flex gap-2">
            <button onclick="toggleFilterCheck(true)" class="text-xs text-blue-400 hover:text-white">全選</button>
            <span class="text-gray-600">|</span>
            <button onclick="toggleFilterCheck(false)" class="text-xs text-blue-400 hover:text-white">全不選</button>
        </div>
        <div id="filterOptions" class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-1">
        </div>
        <div class="p-3 border-t border-white/10 flex justify-end gap-2 bg-[#252525]">
         
           <button onclick="applyFilter()" class="btn-orange px-3 py-1 rounded text-xs font-bold">套用</button>
        </div>
    </div>

    <div id="reminderModal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[800] backdrop-blur-sm">
        <div class="bg-[#202020] border-2 border-orange-500 p-6 rounded-xl shadow-2xl flex flex-col gap-4 w-96 transform transition-all scale-100">
            <h3 class="text-orange-500 font-bold text-xl text-center"><i class="fas fa-exclamation-triangle mr-2"></i>重要提醒</h3>
            
            <div id="reminderContent" class="bg-[#151515] p-4 rounded text-gray-300 text-sm border border-gray-700 max-h-60 overflow-y-auto">
                </div>

            <div class="flex gap-3 mt-2">
                <button onclick="confirmSave()" class="flex-1 bg-green-600 hover:bg-green-500 text-white py-2 rounded font-bold transition-all shadow-lg hover:shadow-green-500/50">
                    <i class="fas fa-check mr-2"></i>確認變更
                </button>
                <button onclick="closeReminderModal()" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white py-2 rounded font-bold">
                    <i class="fas fa-edit mr-2"></i>繼續編輯
                </button>
            </div>
        </div>
    </div>

    <div id="confirmedToast" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-green-600 text-white px-8 py-4 rounded-xl shadow-[0_0_30px_rgba(34,197,94,0.8)] z-[900] hidden flex-col items-center justify-center transition-all opacity-0 scale-90">
        <i class="fas fa-check-circle text-5xl mb-2 text-white drop-shadow-md"></i>
        <span class="text-2xl font-bold tracking-wider drop-shadow-md">已確認</span>
    </div>


    <script>
        let db = { projects: [], masterList: [], orders: [], tasks: [], quotes: [], contacts: [], codes: [] };
        let currentView = 'projects';
        let isSelectionMode = false;
        let selectedIds = new Set();
        let longPressTimer;
        let copyToastTimer;
        let floatCloseTimer = null; 
        
        // V3.5.4 新增至案子列表狀態
        let isAddToProjectMode = false;
        let selectedMasterIds = new Set();
        
        // V3.71.4 匯出報價單模式狀態
        let isExportQuoteMode = false;
        let exportQuoteId = null;

        // V3.5.5 & V3.5.6 Filter & Sort State
        let activeFilters = {};
        // { view: { colKey: Set(values) } }
        let currentFilterCol = null;
        let headerLongPressTimer;
        let activeSort = null; // { col: 'key', order: 'asc'/'desc'/'new'/'old' }
        
        // ==========================================
        // V3.8 User Profile System
        // ==========================================
        let profileMeta = { 
            list: [{id: 'default', name: '預設使用者', avatar: null}], 
            currentId: 'default' 
        };
        const PROFILE_STORAGE_KEY = 'workflow_profiles_meta';
        const DEFAULT_DB_KEY = 'workflowDB_v3_5'; // 舊資料Key，用於相容

        const VIEW_CONFIG = {
            'projects': { title: '案子列表', icon: 'fa-briefcase' },
            'orders': { title: '訂單列表', icon: 'fa-shipping-fast' },
            'tasks': { title: '任務列表', icon: 'fa-tasks' },
            'activities': { title: '活動列表', icon: 'fa-history' },
     
            'quotes': { title: '報價列表', icon: 'fa-file-invoice-dollar' },
            'masterList': { title: '總表維護', icon: 'fa-table' },
            'contacts': { title: '聯絡人清單', icon: 'fa-address-book' },
            'codes': { title: '客戶代碼與行為', icon: 'fa-barcode' }
        };
        
        window.onload = () => {
            initProfileSystem(); // 初始化 Profile 系統
            loadCurrentProfileData(); // 載入當前使用者的 DB

            // V3.71.2 初始化歷史紀錄基準點
            lastSavedState = JSON.stringify(db);
            // 綁定鍵盤快捷鍵 (Ctrl+Z, Ctrl+Y)
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                    e.preventDefault();
                    triggerUndo();
                } else if ((e.ctrlKey || e.metaKey) && e.key === 'y') {
                    e.preventDefault();
                    triggerRedo();
                }
            });

            renderNav();
            switchView('projects');
            autoCheckShipment();
        };
        function toggleSidebar() { 
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('collapsed');
            if(sb.classList.contains('collapsed')) {
                document.body.classList.add('sidebar-collapsed');
            } else {
                document.body.classList.remove('sidebar-collapsed');
            }
        }
        function toggleExportMenu() {
            const menu = document.getElementById('exportSubmenu');
            const arrow = document.getElementById('exportArrow');
            if(menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
                arrow.classList.add('rotate-180');
            } else {
                menu.classList.add('hidden');
                arrow.classList.remove('rotate-180');
            }
        }

        // V3.5.4 新增至案子列表邏輯
        function toggleAddToProjectMode() {
            const btn = document.getElementById('btnAddToProj');
            const span = btn.querySelector('span');
            
            if(!isAddToProjectMode) {
                isAddToProjectMode = true;
                selectedMasterIds.clear();
                btn.classList.add('btn-glow-red');
                span.innerText = '新增至案子列表 (選取中)';
                renderCurrentView();
            } else {
                if(selectedMasterIds.size > 0) {
                    let count = 0;
                    selectedMasterIds.forEach(id => {
                        const m = db.masterList.find(x => x.id === id);
                        if(m) {
                            if(!db.projects.some(p => p.project === m.project)) {
         
                                db.projects.push({
                                    id: Date.now() + Math.random(),
                                    updatedAt: new Date(),
                                    project: m.project,
                                    agent: m.agent,
                          
                                    endUser: m.endUser,
                                    size: m.size,
                                    model: m.model,
               
                                    budget: m.eau, 
                                    plm: m.plm,
                                    active: true,
   
                                    comments: []
                                });
                                count++;
  
                            }
                        }
                    });
                    if(count > 0) {
                        saveToLocal();
                        btn.classList.remove('btn-glow-red');
                        btn.classList.add('btn-glow-green');
                        const toast = document.getElementById('actionToast');
                        
                        toast.querySelector('h3').innerText = '已新增資料';
                        // 修正：確保說明文字 (P 標籤) 是顯示的 (因為批次新增確實預設了 EAU)
                        toast.querySelector('p').style.display = 'block';
                        
                        toast.style.display = 'block';
                        setTimeout(() => { toast.style.display = 'none'; }, 3000);
                    }
                }
                
                isAddToProjectMode = false;
                selectedMasterIds.clear();
                setTimeout(() => {
                    btn.classList.remove('btn-glow-red', 'btn-glow-green');
                    span.innerText = '新增至案子列表';
                }, 1000);
                renderCurrentView();
            }
        }

        function toggleAddMasterSelect(id) {
            if(selectedMasterIds.has(id)) selectedMasterIds.delete(id);
            else selectedMasterIds.add(id);
        }
        function toggleAddMasterSelectAll(cb) {
             const checks = document.querySelectorAll('.master-add-check');
             checks.forEach(c => {
                 const id = parseFloat(c.value);
                 c.checked = cb.checked;
                 if(cb.checked) selectedMasterIds.add(id); else selectedMasterIds.delete(id);
             });
        }

        // 新增：匯出報價單模式切換
        function toggleExportQuoteMode() {
            const btn = document.getElementById('btnExportQuote');
            const span = btn.querySelector('span');

            if (!isExportQuoteMode) {
                // 開啟模式
                isExportQuoteMode = true;
                exportQuoteId = null;
                btn.classList.add('btn-glow-red');
                span.innerText = '匯出報價單 (請勾選一筆)';
                renderCurrentView();
            } else {
                // 已在模式中，再次點擊
                if (exportQuoteId) {
                    // 有選取資料，執行匯出
                    openQuoteExportModal();
                    // 執行後關閉模式
                    isExportQuoteMode = false;
                    exportQuoteId = null;
                    btn.classList.remove('btn-glow-red');
                    span.innerText = '匯出報價單 (Quotation)';
                    renderCurrentView();
                } else {
                    // 無選取資料，視為取消
                    isExportQuoteMode = false;
                    btn.classList.remove('btn-glow-red');
                    span.innerText = '匯出報價單 (Quotation)';
                    renderCurrentView();
                }
            }
        }

        // 新增：報價單單選邏輯 (Radio behavior)
        function toggleExportQuoteSelect(id) {
            if (exportQuoteId === id) {
                exportQuoteId = null; // 取消勾選
            } else {
                exportQuoteId = id; // 選取新的 (會自動取代舊的)
            }
            renderCurrentView(); // 重新渲染以更新 UI 狀態
        }

        function showFloatWindow(content, comment, el) {
            const container = document.getElementById('floatContainer');
            const boxContent = document.getElementById('floatContent');
            const boxComment = document.getElementById('floatComment');

            // 設置內容
            if (content) {
                boxContent.innerText = content;
                boxContent.classList.remove('hidden');
            } else {
                boxContent.classList.add('hidden');
            }

            // 設置註解
            if (comment) {
                boxComment.innerText = comment;
                boxComment.classList.remove('hidden');
            } else {
                boxComment.classList.add('hidden');
            }

            // 如果都沒有，隱藏容器
            if (!content && !comment) {
                container.style.display = 'none';
                return;
            }

            // 計算位置
            container.style.display = 'flex';
            const rect = el.getBoundingClientRect();
            const w = 500; 
            let left = rect.left;
            let top = rect.bottom + 5;
            
            // 邊界檢查
            if (left + w > window.innerWidth) left = window.innerWidth - w - 20;
            // 檢查是否超出底部 (大略計算高度，因為 display:flex 後高度才確定)
            if (top + 200 > window.innerHeight) top = rect.top - 100; // 簡易往上調整
            
            container.style.left = left + 'px';
            container.style.top = top + 'px';
            
            cancelFloatCloseTimer();
        }

        function startFloatCloseTimer() {
            floatCloseTimer = setTimeout(() => {
                document.getElementById('floatWindow').style.display = 'none';
            }, 1000);
        }

        function cancelFloatCloseTimer() {
            clearTimeout(floatCloseTimer);
        }

        function handleGlobalClick(e) {
            const fw = document.getElementById('floatContainer');
            // 點擊非浮動視窗區域即關閉
            if (fw.style.display === 'flex' && !fw.contains(e.target)) {
                fw.style.display = 'none';
            }
            
            // 關閉建議選單
            if(!e.target.closest('.suggestion-container')) {
                document.querySelectorAll('.suggestion-list').forEach(el => el.remove());
            }

            // V3.5.7: 修正 - 篩選視窗只允許點擊 X 關閉，避免誤觸或閃爍
            // 移除舊的自動關閉邏輯
            /* const fm = document.getElementById('filterMenu');
            if (!fm.classList.contains('hidden') && !fm.contains(e.target) && !e.target.closest('th')) {
                closeFilterMenu();
            } 
            */
        }

        function handleLongPressCopy(el, textOverride) {
            el.onmousedown = (e) => {
                if(e.button !== 0) return;
                longPressTimer = setTimeout(() => {
                    const text = textOverride || el.innerText || el.textContent;
                    if(text) {
                        navigator.clipboard.writeText(text).then(() => showToast());
                    }
  
              }, 800);
            };
            el.onmouseup = () => clearTimeout(longPressTimer);
        }

        // [修正] 升級版 Toast：支援自訂訊息(HTML)、時間，若無參數則預設為"已複製"
        function showToast(msg, duration = 3000) {
            const t = document.getElementById('toast');
            
            if (msg) {
                // 有訊息時：支援 \n 換行，並使用 innerHTML 支援粗體
                t.innerHTML = msg.replace(/\n/g, '<br>');
            } else {
                // 無訊息時 (複製功能呼叫)：維持短時間與預設文字
                t.innerText = '已複製';
                duration = 1000;
            }

            t.classList.add('toast-show');
            clearTimeout(copyToastTimer);
            copyToastTimer = setTimeout(() => t.classList.remove('toast-show'), duration);
        }

        function renderNav() {
            const nav = document.getElementById('navMenu');
            nav.innerHTML = Object.keys(VIEW_CONFIG).map(key => {
                if(key === 'activities') return ''; 
                return `<a href="#" onclick="switchView('${key}')" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors border-l-4 border-transparent hover:border-orange-500 nav-item" id="nav-${key}">
                    <i class="fas ${VIEW_CONFIG[key].icon} w-6 text-center"></i> <span class="menu-text">${VIEW_CONFIG[key].title}</span>
                </a>`
 
            }).join('') + 
            `<a href="#" onclick="switchView('activities')" class="flex items-center gap-4 p-4 hover:bg-white/5 text-gray-300 hover:text-white transition-colors border-l-4 border-transparent hover:border-orange-500 nav-item" id="nav-activities">
                <i class="fas fa-history w-6 text-center"></i> <span class="menu-text">活動列表</span>
            </a>`;
        }


// V3.5.74 動態更新排序選項
        function updateSortOptions(view) {
            const select = document.getElementById('sortSelect');
            const opts = select.options;
            // 先顯示所有選項
            for(let i=0; i<opts.length; i++) opts[i].style.display = 'block';
            
            // 重置為第一項
            select.value = 'date_new'; 

            if (view === 'tasks' || view === 'activities') {
                // 任務/活動：隱藏 A-Z, Z-A，預設改為 舊->新 (近->遠)
                // index 2(az), 3(za)
                opts[2].style.display = 'none';
                opts[3].style.display = 'none';
                select.value = 'date_old'; // 預設 近->遠
            } else if (view === 'masterList') {
                // 總表：隱藏 日期排序
                // index 0(new), 1(old)
                opts[0].style.display = 'none';
                opts[1].style.display = 'none';
                select.value = 'az';
            } else if (view === 'projects') {
                // 案子列表：全開，預設 新->舊
                select.value = 'date_new';
            }
        }

        function switchView(view) {
            currentView = view;
            exitSelectionMode();
            
            // 重置功能模式
            isAddToProjectMode = false;
            selectedMasterIds.clear();
            isExportQuoteMode = false;
            exportQuoteId = null;

            activeSort = null; // Reset Sort
            updateSortOptions(view);
            // V3.5.74 更新排序選單
            const btn = document.getElementById('btnAddToProj');
            btn.classList.add('hidden');
            btn.classList.remove('btn-glow-red', 'btn-glow-green');
            btn.querySelector('span').innerText = '新增至案子列表';
            
            // 重置匯出報價單按鈕
            const btnExp = document.getElementById('btnExportQuote');
            btnExp.classList.add('hidden');
            btnExp.classList.remove('btn-glow-red');
            btnExp.querySelector('span').innerText = '匯出報價單 (Quotation)';

            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('border-orange-500', 'bg-white/5', 'text-white');
                el.classList.add('border-transparent', 'text-gray-300');
            });
            const activeEl = document.getElementById('nav-' + (view === 'activities' || view === 'tasks' ? view : view));
            if(activeEl) {
                activeEl.classList.remove('border-transparent', 'text-gray-300');
                activeEl.classList.add('border-orange-500', 'bg-white/5', 'text-white');
            }
            document.getElementById('sectionTitle').innerText = VIEW_CONFIG[view].title;
            if(view === 'masterList') {
                btn.classList.remove('hidden');
            }
            // 新增：僅在報價列表顯示匯出按鈕
            if(view === 'quotes') {
                btnExp.classList.remove('hidden');
            }
            clearSearch();
        }

        function clearSearch() { document.getElementById('searchInput').value = ''; renderCurrentView();
        }

        function getLatestStatus(item) {
            let events = [];
            db.orders.filter(o => o.project === item.project).forEach(o => events.push({ type: '訂單', date: o.createdAt || new Date().toISOString().split('T')[0], text: '訂單' }));
            db.quotes.filter(q => q.project === item.project).forEach(q => events.push({ type: '報價', date: q.date, text: '報價' }));
            
            // 修正：任務動態邏輯，包含 RMA/規格/送樣，並將「詢價」映射為「報價」文字
            db.tasks.filter(t => t.project === item.project).forEach(t => {
                if (['RMA','規格','送樣'].includes(t.taskType)) {
                    events.push({ type: t.taskType, date: t.trackDate || t.startDate, text: t.taskType });
                } else if (t.taskType === '詢價') {
                    events.push({ type: '詢價', date: t.trackDate || t.startDate, text: '報價' });
                }
            });

            events.sort((a,b) => new Date(b.date) - new Date(a.date));

            let manualDate = item.manualLatestDate || '1970-01-01';
            let auto = events[0];
            if (auto && new Date(auto.date) >= new Date(manualDate)) {
                return { text: auto.text, date: auto.date };
            } else if (item.manualLatestStatus) {
                return { text: item.manualLatestStatus, date: item.manualLatestDate };
            }
            return { text: '', date: '' };
        }

        // V3.5.6 Filter Logic (Long Press) & Sorting
        function startHeaderLongPress(e, key) {
            if(!key || key === 'ops') return;
            // V3.5.6 Allowed Star filter
            headerLongPressTimer = setTimeout(() => {
                openFilterMenu(e, key);
            }, 800);
        }

        function cancelHeaderLongPress() {
            clearTimeout(headerLongPressTimer);
        }

        function openFilterMenu(e, key) {
            const menu = document.getElementById('filterMenu');
            if(!menu.classList.contains('hidden') && currentFilterCol === key) return;
            
            const uniqueValues = new Set();
            // 1. 取得基礎資料來源
            let sourceData = currentView === 'tasks' && currentView !== 'activities' ? 
                db.tasks.filter(t => !t.completed) : db[currentView === 'activities' ? 'tasks' : currentView];
            
            // 2. [關鍵修正] 連動篩選：補上 achievement 的處理，確保篩選連動生效
            if(activeFilters[currentView]) {
                sourceData = sourceData.filter(item => {
                    return Object.keys(activeFilters[currentView]).every(filterKey => {
                        // 如果是自己這個欄位 (key)，則忽略
                        if(filterKey === key) return true;
                        
                        const validSet = activeFilters[currentView][filterKey];
                        if(!validSet || validSet.size === 0) return true;

                        if(filterKey === 'star') return validSet.has(item.star ? 'true' : 'false');
                        if(filterKey === 'tags') {
                           if(!item.tags) return false;
                           const itemTags = item.tags.split(/[,，]/).map(t=>t.trim());
                           return [...validSet].some(filterTag => itemTags.includes(filterTag));
                        }
                        if(filterKey === 'latestStatus') {
                             const st = getLatestStatus(item);
                             return validSet.has(st.text);
                        }
                        // [新增] 達成數量篩選連動
                        if(filterKey === 'achievement' && currentView === 'projects') {
                             const ach = calculateAchievement(item);
                             return validSet.has(ach.percent);
                        }
                        if(filterKey === 'dueDate' && currentView === 'orders') {
                            const ships = item.shipments && item.shipments.length ? item.shipments : [{dueDate:item.dueDate}];
                            return ships.some(s => validSet.has(s.dueDate||'-'));
                        }
                        
                        const val = item[filterKey] ? item[filterKey].toString() : '';
                        return validSet.has(val);
                    });
                });
            }

            // 3. 收集選項：補上 achievement 的選項生成
            sourceData.forEach(item => {
                if(key === 'star') {
                    uniqueValues.add(item.star ? 'true' : 'false');
                } else if(key === 'latestStatus') {
                     const st = getLatestStatus(item);
                     if(st.text) uniqueValues.add(st.text);
                } else if(key === 'achievement' && currentView === 'projects') {
                     // [新增] 達成數量選項
                     const ach = calculateAchievement(item);
                     uniqueValues.add(ach.percent);
                } else if(key === 'dueDate' && currentView === 'orders') {
                     const ships = item.shipments && item.shipments.length ? item.shipments : [{dueDate:item.dueDate}];
                     ships.forEach(s => { if(s.dueDate) uniqueValues.add(s.dueDate); });
                } else {
                    const val = item[key] ? item[key].toString() : '';
                    if (val !== '' || key === 'agent') {
                        uniqueValues.add(val);
                    }
                }
            });
            
            currentFilterCol = key;
            const container = document.getElementById('filterOptions');
            container.innerHTML = '';
            if(!activeFilters[currentView]) activeFilters[currentView] = {};
            const currentSet = activeFilters[currentView][key] || new Set([...uniqueValues]); 

            if (uniqueValues.size === 0) {
                 container.innerHTML = '<div class="p-2 text-gray-500 text-xs italic">無符合選項</div>';
            } else {
                Array.from(uniqueValues).sort().forEach(val => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-2 hover:bg-white/5 p-1 rounded cursor-pointer';
                    div.onclick = (e) => {
                        const cb = div.querySelector('input');
                        if(e.target !== cb) cb.checked = !cb.checked;
                    };
                    let displayVal = val;
                    if(key === 'star') {
                        displayVal = val === 'true' ? '<i class="fas fa-star text-yellow-500"></i>' : '<span class="text-gray-500">無星星</span>';
                    } else if (key === 'agent' && val === '') {
                        displayVal = '<span class="text-gray-400 italic">(直客)</span>';
                    }
                    div.innerHTML = `<input type="checkbox" class="accent-orange-500 filter-check" value="${val}" ${currentSet.has(val)?'checked':''}> <span class="text-xs text-gray-300 truncate">${displayVal}</span>`;
                    container.appendChild(div);
                });
            }

            // Sort Section setup
            const sortSection = document.getElementById('sortSection');
            const sortSelect = document.getElementById('filterSortSelect');
            sortSelect.innerHTML = '<option value="">(預設)</option>';
            let showSort = false;
            const addOpt = (val, txt) => sortSelect.innerHTML += `<option value="${val}" ${activeSort && activeSort.col===key && activeSort.order===val ? 'selected' : ''}>${txt}</option>`;
            
            // Logic per View & Column
            if (currentView === 'projects') {
                if (key === 'latestStatus') { showSort = true; addOpt('new', '活動日期(新→舊)'); addOpt('old', '活動日期(舊→新)'); }
                if (['project','agent','endUser','size','model','budget'].includes(key)) { showSort = true; addOpt('az', '字母順序(A→Z)'); addOpt('za', '字母順序(Z→A)'); }
                if (key === 'achievement') { showSort = true; addOpt('az', '數值 (小→大)'); addOpt('za', '數值 (大→小)'); }
            } else if (currentView === 'orders') {
                if (['project','agent','endUser','model'].includes(key)) { showSort = true; addOpt('az', '字母順序(A→Z)'); addOpt('za', '字母順序(Z→A)'); }
                if (key === 'dueDate' || key === 'statusDesc') { showSort = true; addOpt('az', '字母順序(A→Z)'); addOpt('za', '字母順序(Z→A)'); } 
            } else if (currentView === 'tasks' || currentView === 'activities') {
                if (['project','agent','endUser','model'].includes(key)) { showSort = true; addOpt('az', '字母順序(A→Z)'); addOpt('za', '字母順序(Z→A)'); }
                if (key === 'trackDate') { showSort = true; addOpt('new', '活動日期(新→舊)'); addOpt('old', '活動日期(舊→新)'); }
            } else if (currentView === 'quotes') {
                if (['project','agent','endUser','model'].includes(key)) { showSort = true; addOpt('az', '字母順序(A→Z)'); addOpt('za', '字母順序(Z→A)'); }
                if (key === 'date') { showSort = true; addOpt('new', '活動日期(新→舊)'); addOpt('old', '活動日期(舊→新)'); }
            } else if (currentView === 'masterList') {
                if (['project','agent','endUser','eau','size','model'].includes(key)) { showSort = true; addOpt('az', '字母順序(A→Z)'); addOpt('za', '字母順序(Z→A)'); }
            }

            sortSection.classList.toggle('hidden', !showSort);
            menu.style.left = Math.min(e.clientX, window.innerWidth - 270) + 'px';
            menu.style.top = Math.min(e.clientY, window.innerHeight - 450) + 'px';
            menu.classList.remove('hidden');
            menu.classList.add('flex');
        }

        function closeFilterMenu() {
            document.getElementById('filterMenu').classList.add('hidden');
            document.getElementById('filterMenu').classList.remove('flex');
            currentFilterCol = null;
        }

        function toggleFilterCheck(check) {
            document.querySelectorAll('.filter-check').forEach(c => c.checked = check);
        }

        function applySort(order) {
            if(!order) {
                activeSort = null;
            } else {
                activeSort = { col: currentFilterCol, order: order };
            }
            renderCurrentView();
        }

        function applyFilter() {
            if(!currentFilterCol) return;
            const checks = document.querySelectorAll('.filter-check');
            const checkedVals = new Set();
            checks.forEach(c => {
                if(c.checked) checkedVals.add(c.value);
            });
            // V3.5.6: If all selected (equal to total options), remove filter (Icon disappear)
            if(checks.length > 0 && checkedVals.size === checks.length) {
                if(activeFilters[currentView]) delete activeFilters[currentView][currentFilterCol];
            } else {
                if(!activeFilters[currentView]) activeFilters[currentView] = {};
                activeFilters[currentView][currentFilterCol] = checkedVals;
            }

            closeFilterMenu();
            renderCurrentView();
        }


function renderCurrentView() {
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const sortMode = document.getElementById('sortSelect').value;

            tbody.innerHTML = '';
            let columns = [];
            let sourceData = [];

            const commonOps = { t: '操作', w: '80px', k:'ops', c: 'sticky-right' };
            const projectColW = '80px';
            const modelColSpec = { t: 'Model', w: '150px', k:'model', c: 'sticky-col col-5 text-model text-[10px]' };
            
            if(currentView === 'projects') {
                sourceData = db.projects;
                columns = [
                    { t: '<i class="fas fa-star text-yellow-500"></i>', w: '40px', k:'star', c: 'sticky-col col-0 text-center' },
                    { t: 'Project', w: projectColW, k:'project', c: 'sticky-col col-1 text-small-gray' },
                    { t: 'Agent', w: '80px', k:'agent', c: 'sticky-col col-2 text-small-gray' },
                    { t: 'End User', w: '80px', k:'endUser', c: 'sticky-col col-3 text-small-gray' },
                    { t: 'Size', w: '60px', k:'size', c: 'sticky-col col-4 text-center' },
                    modelColSpec,
                    { t: '<i class="fas fa-history mr-1"></i>最新動態', w: '120px', k:'latestStatus', c: 'sticky-col col-6 col-latest' },
                    { t: '標籤', w: '150px', k:'tags' },
                    { t: '狀況概述', w: '250px', k:'summary' },
                    { t: '達成數量', w: '80px', k:'achievement' },
                    { t: '當年預算', w: '80px', k:'budget', c: 'text-center' },
                    { t: 'Active', w: '60px', k:'active' },
                    { t: 'PLM#', w: '80px', k:'plm' },
                    commonOps
                ];
            } else if (currentView === 'masterList') {
                sourceData = db.masterList;
                columns = [
                    { t: '', w: '40px', c: 'sticky-col col-0' },
                    { t: 'Project', w: '120px', k:'project', c: 'sticky-col col-1 text-small-gray' },
                    { t: 'Agent', w: '80px', k:'agent', c: 'sticky-col col-2 text-small-gray' },
                    { t: 'End User', w: '80px', k:'endUser', c: 'sticky-col col-3 text-small-gray' },
                    { t: 'Application', w: '100px', k:'application' },
                    { t: 'EAU', w: '80px', k:'eau', c: 'text-center' },
                    { t: 'Size', w: '60px', k:'size', c: 'text-center' },
                    { t: 'Model', w: '150px', k:'model', c:'text-model text-[10px]' },
                    { t: '標籤', w: '150px', k:'tags' },
                    { t: 'Price', w: '80px', k:'salesPrice' },
                    { t: 'Remark', w: '200px', k:'remark' },
                    { t: 'Contact', w: '100px', k:'contact' },
                    { t: 'Cus PN', w: '100px', k:'cusPN' },
                    { t: 'Active', w: '60px', k:'active' },
                    { t: 'PLM#', w: '80px', k:'plm' },
                    commonOps
                ];
            } else if (currentView === 'tasks' || currentView === 'activities') {
                sourceData = currentView === 'tasks' ? db.tasks.filter(t => !t.completed) : db.tasks;
                columns = [
                    { t: '★', w: '40px', c: 'sticky-col col-0 text-center' }, 
                    { t: 'Project', w: '150px', k: 'project', c: 'sticky-col col-1 text-small-gray' }, 
                    { t: 'Agent', w: '100px', k: 'agent', c: 'sticky-col col-2 text-small-gray' }, 
                    { t: 'End User', w: '80px', k: 'endUser', c: 'sticky-col col-3 text-small-gray' },
                    { t: 'Model', w: '150px', k: 'model', c: 'sticky-col col-4 text-model text-[10px]' },
                    { t: '任務', w: '80px', k: 'taskType' }, 
                    { t: '任務說明', w: '200px', k: 'desc' }, 
                    { t: '文件#', w: '100px', k: 'docNum' },
                    { t: '起始/追蹤', w: '120px', k: 'trackDate' }, 
                    { t: '狀態', w: '80px' }, 
                    { t: '完成日', w: '100px', k: 'completedDate' },
                    commonOps
                ];
            } else if (currentView === 'orders') {
                sourceData = db.orders;
                columns = [
                    { t: '★', w: '40px' }, 
                    { t: 'Project', w: '120px', k:'project' }, 
                    { t: 'Agent', w: '80px', k:'agent' }, 
                    { t: 'End User', w: '80px', k:'endUser' },
                    { t: 'Model', w: '100px', c:'text-model', k:'model' }, 
                    { t: 'PO#', w: '100px', k:'po' }, 
                    { t: 'Qty', w: '60px', k:'qty' },
                    { t: '交期', w: '100px', k:'dueDate' }, 
                    { t: '出貨', w: '60px' }, 
                    { t: '狀態說明', w: '150px', k:'statusDesc' }, 
                    commonOps
                ];
            } else if (currentView === 'quotes') {
                sourceData = db.quotes;
                columns = [
                    { t: 'Project', w: '150px', k:'project', c: 'text-xs' }, 
                    { t: 'Agent', w: '100px', k:'agent', c: 'text-xs' }, 
                    { t: 'End User', w: '100px', k:'endUser', c: 'text-xs' },
                    { t: 'Model', w: '130px', k:'model', c: 'text-model text-xs font-bold' },
                    { t: '日期', w: '70px', k:'date' }, 
                    { t: '業務報價', w: '100px', c:'text-orange-300 font-bold', k:'salesPrice' },
                    { t: 'FAE報價', w: '100px', k:'faePrice' }, 
                    { t: 'REF#', w: '100px', k:'ref', c: 'text-xs text-gray-400' }, 
                    { t: '說明', w: '200px', k:'desc' }, 
                    { t: '操作', w: '60px', c:'sticky-right' }
                ];
            } else if (currentView === 'contacts') {
                sourceData = db.contacts;
                columns = [
                    { t: '★', w: '40px' }, 
                    { t: 'Agent', w: '120px', k:'agent' }, 
                    { t: 'End User', w: '120px', k:'endUser' },
                    { t: 'Name', w: '100px', k:'name' }, 
                    { t: 'Email', w: '150px', k:'email' },
                    { t: 'Position', w: '120px', k:'position' }, 
                    { t: 'Phone', w: '120px', k:'phone' }, 
                    { t: 'Address', w: '200px', k:'address' },
                    { t: 'Remark', w: '150px', k:'remark' }, 
                    commonOps
                ];
            } else if (currentView === 'codes') {
                sourceData = db.codes;
                columns = [
                    { t: 'Agent', w: '150px', k:'agent' }, 
                    { t: 'End User', w: '150px', k:'endUser' }, 
                    { t: 'Code', w: '100px', c:'text-model', k:'code' },
                    { t: 'Pricing', w: '100px', k:'pricing' }, 
                    { t: 'Logistics', w: '100px', k:'logistics' }, 
                    { t: 'Remark', w: '200px', k:'remark' },
                    { t: '操作', w: '60px', c:'sticky-right' }
                ];
            }

            if(isSelectionMode) {
                columns.unshift({ 
                    t: '<input type="checkbox" onchange="toggleSelectAll(this)" class="accent-orange-500 cursor-pointer">', 
                    w: '40px', c:'sticky-col col-check text-center' 
                });
            }

            if(isAddToProjectMode && currentView === 'masterList') {
                columns[0] = { 
                    t: '<input type="checkbox" onchange="toggleAddMasterSelectAll(this)" class="accent-orange-500 cursor-pointer">', 
                    w: '40px', c:'sticky-col col-0 text-center' 
                };
            }

            if(isExportQuoteMode && currentView === 'quotes') {
                columns.unshift({
                    t: '<span class="text-xs text-orange-500">選取</span>',
                    w: '50px', c: 'sticky-col col-0 text-center'
                });
            }

            // 產生表頭 HTML
            thead.innerHTML = `<tr>${columns.map(c => {
                const isFiltered = activeFilters[currentView] && activeFilters[currentView][c.k];
                const filterIcon = isFiltered ? '<i class="fas fa-filter text-orange-500 ml-1 text-[10px]"></i>' : '';
                return `<th style="width:${c.w}; min-width:${c.w}" 
                            class="${c.c||''}"
                            onmousedown="startHeaderLongPress(event, '${c.k}')"
                            onmouseup="cancelHeaderLongPress()"
                        >${c.t}${filterIcon}</th>`
            }).join('')}</tr>`;

            // 篩選邏輯重構 (必須與 openFilterMenu 保持一致)
            let filtered = sourceData;
            if(activeFilters[currentView]) {
                filtered = filtered.filter(item => {
                    return Object.keys(activeFilters[currentView]).every(key => {
                        const validSet = activeFilters[currentView][key];
                        if(!validSet) return true;

                        if(key === 'star') return validSet.has(item.star ? 'true' : 'false');
                        if(key === 'tags') {
                           if(!item.tags) return false;
                           const itemTags = item.tags.split(/[,，]/).map(t=>t.trim());
                           return [...validSet].some(filterTag => itemTags.includes(filterTag));
                        }
                        if(key === 'latestStatus') {
                             const st = getLatestStatus(item);
                             return validSet.has(st.text);
                        }
                        if(key === 'dueDate' && currentView === 'orders') {
                            const ships = item.shipments && item.shipments.length ? item.shipments : [{dueDate:item.dueDate}];
                            return ships.some(s => validSet.has(s.dueDate||'-'));
                        }
                        // [新增] 達成數量篩選連動 (修正篩選無效問題)
                        if(key === 'achievement' && currentView === 'projects') {
                            const ach = calculateAchievement(item);
                            return validSet.has(ach.percent);
                        }

                        const val = item[key] ? item[key].toString() : '';
                        return validSet.has(val);
                    });
                });
            }

            filtered = filtered.filter(item => Object.values(item).join(' ').toLowerCase().includes(search));

            // 排序核心功能
            const doSort = (a, b) => {
                const safeTime = (d) => d ? new Date(d).getTime() : 0;

                // 0. Active false 沉底
                if (a.active !== false && b.active === false) return -1;
                if (a.active === false && b.active !== false) return 1;

                // 1. 指定欄位排序
                if(activeSort) {
                    const { col, order } = activeSort;
                    let valA, valB;
                    
                    if (col === 'achievement') {
                        const getAchVal = (i) => {
                            try {
                                return parseFloat(calculateAchievement(i).percent) || 0;
                            } catch(e) { return 0; }
                        };
                        valA = getAchVal(a);
                        valB = getAchVal(b);
                        
                        if(order === 'az') return valA - valB; 
                        if(order === 'za') return valB - valA; 
                        return 0;
                    } 
                    else if(col === 'latestStatus') {
                        valA = getLatestStatus(a).date || '';
                        valB = getLatestStatus(b).date || '';
                        if(order === 'new') return safeTime(valB) - safeTime(valA);
                        if(order === 'old') return safeTime(valA) - safeTime(valB);
                    } else if (col === 'trackDate') { 
                        valA = a.trackDate || a.startDate || '';
                        valB = b.trackDate || b.startDate || '';
                        if(order === 'new') return safeTime(valB) - safeTime(valA);
                        if(order === 'old') return safeTime(valA) - safeTime(valB);
                    } else if (col === 'budget') {
                        valA = parseFloat((a.budget||'0').toString().replace(/,/g,'')) || 0;
                        valB = parseFloat((b.budget||'0').toString().replace(/,/g,'')) || 0;
                        if(order === 'az') return valA - valB; 
                        if(order === 'za') return valB - valA;
                    } else if (col === 'dueDate' && currentView === 'orders') {
                         const getEarliest = (i) => {
                              const ships = i.shipments || [{dueDate:i.dueDate}];
                             const dates = ships.map(s=>s.dueDate).filter(d=>d).sort();
                             return dates[0] || '9999-99-99';
                         };
                        valA = getEarliest(a); valB = getEarliest(b);
                    } else {
                        valA = a[col] || '';
                        valB = b[col] || '';
                    }

                    if(order === 'new') return new Date(valB) - new Date(valA);
                    if(order === 'old') return new Date(valA) - new Date(valB);
                    if(order === 'az') return valA.toString().localeCompare(valB.toString());
                    if(order === 'za') return valB.toString().localeCompare(valA.toString());
                }

                // 2. 全域預設排序
                if (currentView === 'projects' && (sortMode === 'date_new' || sortMode === 'date_old')) {
                    const dateA = getLatestStatus(a).date || '';
                    const dateB = getLatestStatus(b).date || '';
                    if(sortMode === 'date_new') return safeTime(dateB) - safeTime(dateA);
                    if(sortMode === 'date_old') return safeTime(dateA) - safeTime(dateB);
                } 
                
                let valA = a.updatedAt || a.date || a.startDate || ''; 
                let valB = b.updatedAt || b.date || b.startDate || '';
                if(sortMode === 'date_new') return new Date(valB) - new Date(valA);
                if(sortMode === 'date_old') return new Date(valA) - new Date(valB);
                if(sortMode === 'az') return (a.project || a.agent || '').localeCompare(b.project || b.agent || '');
                if(sortMode === 'za') return (b.project || b.agent || '').localeCompare(a.project || a.agent || '');
                return 0;
            };

            if(currentView === 'tasks' || currentView === 'activities') {
                const today = new Date().toISOString().split('T')[0];
                const getMs = (d) => d ? new Date(d).getTime() : 9999999999999;
                const isOverdue = (t) => !t.completed && t.active !== false && t.trackDate && t.trackDate < today;
                const overdueItems = filtered.filter(isOverdue);
                const normalItems = filtered.filter(t => !isOverdue(t));
                overdueItems.sort((a,b) => getMs(a.trackDate) - getMs(b.trackDate));
                
                if (!activeSort) {
                    if (sortMode === 'date_new') {
                         normalItems.sort((a, b) => {
                             if (a.active !== false && b.active === false) return -1;
                             if (a.active === false && b.active !== false) return 1;
                             return getMs(b.trackDate) - getMs(a.trackDate);
                        });
                    } else {
                        normalItems.sort((a, b) => {
                             if (a.active !== false && b.active === false) return -1;
                             if (a.active === false && b.active !== false) return 1;
                             return getMs(a.trackDate) - getMs(b.trackDate);
                        });
                    }
                } else {
                    normalItems.sort(doSort);
                }
                filtered = [...overdueItems, ...normalItems];
            } else {
                filtered.sort(doSort);
            }

            if(filtered.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
            } else {
                document.getElementById('emptyState').classList.add('hidden');
                filtered.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.className = 'table-row';
                    tr.dataset.id = item.id;
                    
                    tr.onmousedown = (e) => {
                        if(e.target.closest('.cell-content') || e.target.closest('.sticky-col')) {
                        } else {
                            startLongPress(tr); 
                        }
                    };
                    tr.onmouseup = cancelLongPress;
                    tr.onmouseleave = cancelLongPress;
                 
                    if(item.active === false || item.completed) tr.style.opacity = '0.5';

                    const isSel = selectedIds.has(item.id);
                    const starClass = item.star ? 'star-active text-yellow-400' : 'star-inactive text-gray-600';
                    const starHTML = `<i class="fas fa-star ${starClass} hover:scale-125 transition-transform cursor-pointer" onclick="toggleStar('${currentView}', ${item.id})"></i>`;
                    const actionsHTML = `<div class="flex justify-center gap-2 h-full items-center"><button onclick="openModal('edit', ${item.id})" class="text-gray-400 hover:text-white"><i class="fas fa-edit"></i></button><button onclick="deleteItem(${item.id})" class="text-red-900 hover:text-red-500"><i class="fas fa-trash-alt"></i></button></div>`;
                    const checkHTML = `<input type="checkbox" class="accent-orange-500 row-check cursor-pointer transform scale-125" value="${item.id}" ${isSel?'checked':''} onchange="toggleSelectRow(${item.id})">`;
                    
                    const genCell = (val, fieldName, alignClass = '', extraTooltip = null) => {
                        const comment = (item.comments || []).find(c => c.field === fieldName);
                        const hasCommentClass = comment ? 'has-comment' : '';
                        const displayVal = val || '';
                        const cellDisplayText = displayVal.toString().replace(/(\r\n|\n|\r)/g, " / ");
                        const escapeStr = (str) => {
                            if (!str) return '';
                            return str.toString().replace(/\\/g, "\\\\").replace(/'/g, "&#39;").replace(/(\r\n|\n|\r)/g, "\\n");
                        };
                        const safeVal = escapeStr(displayVal);
                        let rawComment = comment ? comment.text : '';
                        if (extraTooltip) {
                            const tooltipInfo = `FAE報價: ${extraTooltip}`;
                            if (rawComment) rawComment = tooltipInfo + "\n----------------\n" + rawComment;
                            else rawComment = tooltipInfo;
                        }
                        const commentText = escapeStr(rawComment);
                        return `<div class="cell-content ${hasCommentClass} ${alignClass}" 
                                    onmouseleave="startFloatCloseTimer()"
                                    onmouseenter="handleCellHover(this, '${commentText}', '${safeVal}', false)"
                                    onclick="handleCellHover(this, '${commentText}', '${safeVal}', true)"
                                    onmousedown="handleLongPressCopy(this)">
                                    ${cellDisplayText}
                                  </div>`;
                    };

                    let cells = '';
                    if(currentView === 'projects') {
                        const ach = calculateAchievement(item);
                        const latest = getLatestStatus(item);
                        const displayBudget = item.budget ? parseFloat(item.budget.toString().replace(/,/g,'')).toLocaleString() : '';
                        cells = `
                            <td class="sticky-col col-0 text-center"><div class="cell-content justify-center">${starHTML}</div></td>
                            <td class="sticky-col col-1 text-small-gray">${genCell(item.project, 'project')}</td>
                            <td class="sticky-col col-2 text-small-gray">${genCell(item.agent, 'agent')}</td>
                            <td class="sticky-col col-3 text-small-gray">${genCell(item.endUser, 'endUser')}</td>
                            <td class="sticky-col col-4 text-center">${genCell(item.size, 'size', 'justify-center')}</td>
                            <td class="sticky-col col-5 text-model text-[10px]">${genCell(item.model, 'model')}</td>
                            <td class="sticky-col col-6 col-latest">
                                <div class="flex flex-col leading-tight justify-center h-full px-2">
                                    <span class="text-white font-bold text-xs mb-1">${renderTags(latest.text)}</span>
                                    <span class="text-[10px] text-gray-400">${latest.date}</span>
                                </div>
                            </td>
                            <td>${renderTags(item.tags)}</td>
                            <td>${genCell(item.summary, 'summary')}</td>
                            <td class="text-center">
                                <div class="cell-content flex-col justify-center leading-tight">
                                    <span class="text-orange-400 font-bold">${ach.qty}</span>
                                    <span class="text-[10px] text-gray-500">${ach.percent}</span>
                                </div>
                            </td>
                            <td class="text-right">${genCell(displayBudget, 'budget', 'justify-end')}</td>
                            <td class="text-center"><div class="cell-content justify-center">${item.active!==false ? 'Y' : 'N'}</div></td>
                            <td>${genCell(item.plm, 'plm')}</td>
                            <td class="text-center sticky-right">${actionsHTML}</td>
                        `;
                    } else if (currentView === 'masterList') {
                        const lastQuote = db.quotes.filter(q => q.project === item.project).sort((a,b)=>new Date(b.date)-new Date(a.date))[0];
                        const displayPrice = lastQuote ? lastQuote.salesPrice : (item.salesPrice || '');
                        const displayFae = lastQuote ? lastQuote.faePrice : '';
                        const displayEau = item.eau ? parseFloat(item.eau.toString().replace(/,/g,'')).toLocaleString() : '';
                        let col0Content = '';
                        if(isAddToProjectMode) {
                            const exists = db.projects.some(p => p.project === item.project);
                            if(!exists) {
                                const isChecked = selectedMasterIds.has(item.id);
                                col0Content = `<input type="checkbox" class="accent-orange-500 master-add-check cursor-pointer transform scale-125" value="${item.id}" ${isChecked?'checked':''} onchange="toggleAddMasterSelect(${item.id})">`;
                            }
                        }
                        cells = `
                            <td class="sticky-col col-0 text-center"><div class="cell-content justify-center">${col0Content}</div></td>
                            <td class="sticky-col col-1 text-small-gray">${genCell(item.project, 'project')}</td>
                            <td class="sticky-col col-2 text-small-gray">${genCell(item.agent, 'agent')}</td>
                            <td class="sticky-col col-3 text-small-gray">${genCell(item.endUser, 'endUser')}</td>
                            <td>${genCell(item.application, 'application')}</td>
                            <td class="text-right">${genCell(displayEau, 'eau', 'justify-end')}</td>
                            <td class="text-center">${genCell(item.size, 'size', 'justify-center')}</td>
                            <td class="text-model text-[10px]">${genCell(item.model, 'model')}</td>
                            <td>${renderTags(item.tags)}</td>
                            <td>${genCell(displayPrice, 'salesPrice', '', displayFae)}</td>
                            <td>${genCell(item.remark, 'remark')}</td>
                            <td>${genCell(item.contact, 'contact')}</td>
                            <td>${genCell(item.cusPN, 'cusPN')}</td>
                            <td class="text-center"><div class="cell-content justify-center">${item.active!==false ? 'Y' : 'N'}</div></td>
                            <td>${genCell(item.plm, 'plm')}</td>
                            <td class="text-center sticky-right">${actionsHTML}</td>
                        `;
                    } else if (currentView === 'tasks' || currentView === 'activities') {
                        const todayStr = new Date().toISOString().split('T')[0];
                        const isOverdue = !item.completed && item.trackDate && item.trackDate < todayStr;
                        const futureTarget = new Date();
                        futureTarget.setDate(futureTarget.getDate() + 7);
                        const futureStr = futureTarget.toISOString().split('T')[0];
                        const isFuture = !item.completed && item.trackDate && item.trackDate > futureStr;
                        let dateClass = 'text-gray-400';
                        if (isOverdue) dateClass = 'text-red-500 font-bold';
                        else if (isFuture) dateClass = 'text-[#22337C]';
                        
                        const masterItem = db.masterList.find(m => m.project === item.project);
                        const displayModel = masterItem ? masterItem.model : '';
                        const displayCompDate = item.completed ? genCell(item.completedDate, 'completedDate') : '';
                        cells = `<td class="sticky-col col-0 text-center"><div class="cell-content justify-center">${starHTML}</div></td>
                        <td class="sticky-col col-1 text-small-gray">${genCell(item.project,'project')}</td>
                        <td class="sticky-col col-2 text-small-gray">${genCell(item.agent,'agent')}</td>
                        <td class="sticky-col col-3 text-small-gray">${genCell(item.endUser,'endUser')}</td>
                        <td class="text-model text-[10px]">${genCell(displayModel,'model')}</td>
                        <td><span class="tag-badge tag-blue">${item.taskType||''}</span></td><td>${genCell(item.desc,'desc')}</td><td class="font-mono text-xs">${genCell(item.docNum,'docNum')}</td>
                        <td class="${dateClass} text-xs"><div>起: ${item.startDate}</div><div>追: ${item.trackDate}</div></td>
                        <td>${item.completed ? '<span class="text-gray-500">已完成</span>' : '<span class="text-green-500">進行中</span>'}</td>
                        <td class="text-xs text-gray-400">${displayCompDate}</td>
                        <td class="text-center sticky-right">${actionsHTML}</td>`;
                    } else if (currentView === 'orders') {
                        const ships = item.shipments && item.shipments.length ? item.shipments : [{dueDate: item.dueDate, qty: item.qty, isShipped: item.isShipped}];
                        const qtysHtml = ships.map(s => `<div>${s.qty||0}</div>`).join('');
                        const datesHtml = ships.map(s => `<div>${s.dueDate||'-'}</div>`).join('');
                        const shippedHtml = ships.map(s => s.isShipped ? '<span class="text-green-500">✓</span>' : '<span class="text-gray-600">-</span>').join('<br>');
                        cells = `<td class="text-center"><div class="cell-content justify-center">${starHTML}</div></td><td>${genCell(item.project,'project')}</td><td>${genCell(item.agent,'agent')}</td><td>${genCell(item.endUser,'endUser')}</td><td class="text-model">${genCell(item.model,'model')}</td>
                            <td>${genCell(item.po,'po')}</td>
                            <td class="font-mono text-xs"><div class="cell-content flex-col justify-center items-start">${qtysHtml}</div></td>
                            <td class="text-xs"><div class="cell-content flex-col justify-center items-start">${datesHtml}</div></td>
                            <td class="text-center text-xs"><div class="cell-content flex-col justify-center">${shippedHtml}</div></td>
                            <td>${genCell(item.statusDesc,'statusDesc')}</td><td class="text-center sticky-right">${actionsHTML}</td>`;
                    } else if (currentView === 'quotes') {
                        let quoteCheckHtml = '';
                        if (isExportQuoteMode) {
                            const isChecked = item.id === exportQuoteId;
                            quoteCheckHtml = `<td class="sticky-col col-0 text-center">
                                            <input type="checkbox" class="accent-orange-500 cursor-pointer transform scale-125" 
                                            ${isChecked ? 'checked' : ''} onchange="toggleExportQuoteSelect(${item.id})">
                                        </td>`;
                        }
                        cells = `${quoteCheckHtml}<td class="text-xs">${genCell(item.project,'project')}</td><td class="text-xs">${genCell(item.agent,'agent')}</td><td class="text-xs">${genCell(item.endUser,'endUser')}</td>
                                <td class="text-model text-[10px]">${genCell(item.model,'model')}</td>
                                <td class="text-[10px] text-gray-400">${item.date}</td><td class="text-[#E34D00] font-bold text-xs">${genCell(item.salesPrice,'salesPrice')}</td>
                                <td class="text-[10px] text-gray-400">${genCell(item.faePrice,'faePrice')}</td><td class="text-xs text-gray-400">${genCell(item.ref,'ref')}</td><td>${genCell(item.desc,'desc')}</td><td class="text-center sticky-right">${actionsHTML}</td>`;
                    } else if (currentView === 'contacts') {
                        cells = `<td class="text-center"><div class="cell-content justify-center">${starHTML}</div></td><td>${genCell(item.agent,'agent')}</td><td>${genCell(item.endUser,'endUser')}</td>
                            <td>${genCell(item.name,'name')}</td><td>${genCell(item.email,'email')}</td>
                            <td>${genCell(item.position,'position')}</td><td>${genCell(item.phone,'phone')}</td>
                            <td class="text-xs text-gray-400">${genCell(item.address,'address')}</td><td class="text-xs">${genCell(item.remark,'remark')}</td><td class="text-center sticky-right">${actionsHTML}</td>`;
                    } else if (currentView === 'codes') {
                        cells = `<td>${genCell(item.agent,'agent')}</td><td>${genCell(item.endUser,'endUser')}</td><td class="font-mono text-model">${genCell(item.code,'code')}</td><td>${genCell(item.pricing,'pricing')}</td><td>${genCell(item.logistics,'logistics')}</td>
                            <td class="text-xs">${genCell(item.remark,'remark')}</td><td class="text-center sticky-right">${actionsHTML}</td>`;
                    }

                    if(isSelectionMode) {
                        cells = `<td class="sticky-col col-check text-center"><div class="cell-content justify-center">${checkHTML}</div></td>` + cells;
                    }

                    tr.innerHTML = cells;
                    tbody.appendChild(tr);
                });
            }
        }

        function handleCellHover(el, commentText, cellValue, isClick = false) {
            cancelFloatCloseTimer();
            
            let contentToShow = null;
            let commentToShow = null;

            // 判斷是否顯示內容：點擊(強制顯示) 或 溢位(Hover顯示)
            const isOverflow = el.scrollWidth > el.clientWidth;
            if ((isClick || isOverflow) && cellValue) {
                contentToShow = cellValue;
            }

            // 判斷是否顯示註解：有點擊或Hover，且有註解就顯示
            if (commentText) {
                commentToShow = commentText;
            }

            if (contentToShow || commentToShow) {
                showFloatWindow(contentToShow, commentToShow, el);
            }
        }

        function startLongPress(row) { longPressTimer = setTimeout(() => { if(!isSelectionMode) enterSelectionMode(row.dataset.id); }, 800);
        }
        function cancelLongPress() { clearTimeout(longPressTimer);
        }
        function enterSelectionMode(id) { 
            isSelectionMode = true;
            document.body.classList.add('select-mode'); 
            document.getElementById('batchDeleteBtn').classList.remove('hidden'); 
            document.getElementById('exitSelectModeBtn').classList.remove('hidden'); 
            if(id) selectedIds.add(parseFloat(id)); 
            renderCurrentView(); 
        }
        function exitSelectionMode() { 
            isSelectionMode = false;
            document.body.classList.remove('select-mode'); 
            selectedIds.clear(); 
            document.getElementById('batchDeleteBtn').classList.add('hidden'); 
            document.getElementById('exitSelectModeBtn').classList.add('hidden'); 
            renderCurrentView(); 
        }
        
        function toggleSelectAll(cb) {
            const visibleChecks = document.querySelectorAll('#tableBody .row-check');
            visibleChecks.forEach(c => {
                c.checked = cb.checked;
                const id = parseFloat(c.value);
                if(cb.checked) selectedIds.add(id); else selectedIds.delete(id);
            });
            updateBatchBtnText();
        }
        function toggleSelectRow(id) { if(selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id); updateBatchBtnText();
        }
        function updateBatchBtnText() { document.getElementById('batchDeleteBtn').innerHTML = `<i class="fas fa-trash-alt mr-1"></i>刪除選取 (${selectedIds.size})`;
        }
        function deleteSelected() { if(!confirm(`確定刪除 ${selectedIds.size} 筆?`)) return;
        const t = currentView === 'activities' ? 'tasks' : currentView; db[t] = db[t].filter(i => !selectedIds.has(i.id)); exitSelectionMode(); saveToLocal();
        }

        function renderTags(str) { return str ?
        str.split(/[,，]/).filter(t=>t.trim()).map(t => `<span class="tag-badge tag-blue">${t.trim()}</span>`).join('') : ''; }
        
        function calculateAchievement(proj) { 
            // [修正] 增加移除逗號的邏輯，確保數字解析正確
            const cleanNum = (n) => parseFloat((n||'').toString().replace(/,/g,'')) || 0;
            const budget = cleanNum(proj.budget);
            
            // [安全防護] 確保 db.orders 存在，避免初始化未完成時報錯 (這是防止排序後資料消失的關鍵)
            const orders = (db && db.orders) ? db.orders : [];

            try {
                const qty = orders.filter(o => o.project === proj.project)
                            .reduce((s,o) => {
                                const ships = o.shipments && o.shipments.length > 0 ? o.shipments : [{qty: o.qty}];
                                return s + ships.reduce((ss, sh) => ss + cleanNum(sh.qty), 0);
                            }, 0);
                
                return {qty, percent: budget ? Math.round((qty/budget)*100)+'%' : '0%'};
            } catch (e) {
                console.warn('Achievement calc error:', e);
                return {qty: 0, percent: '0%'};
            }
        }
        function toggleStar(v,id) { const t=v==='activities'?'tasks':v; const i=db[t].find(x=>x.id===id);
            if(i){i.star=!i.star;saveToLocal();renderCurrentView();} }

        // ==========================================
        // V3.8.2 全域 Undo/Redo 核心邏輯
        // ==========================================
        let historyStack = [];
        let redoStack = [];
        let isTimeTravel = false; // 標記是否正在執行還原/重作，避免迴圈記錄
        let lastSavedState = '';  // 紀錄上一次存檔的狀態字串

        // 改寫 saveToLocal：在儲存前將「舊狀態」推入歷史堆疊
        function saveToLocal() { 
            const currentState = JSON.stringify(db);
            // 如果不是因為執行 Undo/Redo 而觸發的存檔，且狀態真的有改變
            if (!isTimeTravel && lastSavedState && lastSavedState !== currentState) {
                historyStack.push(lastSavedState);
                if (historyStack.length > 50) historyStack.shift(); // 限制最多 50 步
                redoStack = [];
                // 只要有新動作，重作堆疊就失效
                updateUndoRedoUI();
            }

            // V3.8 修改：根據當前 Profile ID 決定存檔 Key
            // 如果是 default，為了保持相容性，仍使用 workflowDB_v3_5
            // 如果是新 Profile，使用 workflowDB_profile_{ID}
            const dbKey = profileMeta.currentId === 'default' ? 
                          DEFAULT_DB_KEY : `workflowDB_profile_${profileMeta.currentId}`;
            
            localStorage.setItem(dbKey, currentState);
            lastSavedState = currentState;
            // 更新當前基準
        }

        function triggerUndo() {
            if (historyStack.length === 0) return showToast("無步驟可還原");
            
            const prevState = historyStack.pop();
            redoStack.push(JSON.stringify(db)); // 將當前狀態推入重作堆疊
            
            applyState(prevState);
            showToast("已還原");
        }

        function triggerRedo() {
            if (redoStack.length === 0) return showToast("無步驟可重作");

            const nextState = redoStack.pop();
            historyStack.push(JSON.stringify(db)); // 將當前狀態推入歷史堆疊

            applyState(nextState);
            showToast("已重作");
        }

        function applyState(stateStr) {
            isTimeTravel = true; // 鎖定：這次變更不要再次推入 historyStack
            db = JSON.parse(stateStr);
            saveToLocal(); // 儲存到 LocalStorage (確保 F5 後停在還原的狀態)
            renderCurrentView();
            isTimeTravel = false; // 解鎖
            updateUndoRedoUI();
        }
        
        // 視覺回饋：當無步驟時讓按鈕變更淡 (選用)
        function updateUndoRedoUI() {
            // 進階優化：可在此處改變按鈕顏色 (目前用 Toast 提示即可)
        }

        // Modal Logic
        let editingId = null;
        function openModal(mode, id) {
            editingId = id;
            document.getElementById('mainModal').classList.remove('hidden'); document.getElementById('mainModal').classList.add('flex');
            const typeSel = document.getElementById('modalType');
            if(mode === 'add') {
                document.getElementById('modalTitle').innerHTML = '<i class="fas fa-plus-circle mr-2"></i>新增資料';
                typeSel.disabled = false; typeSel.value = (currentView==='activities'||currentView==='tasks')?'tasks':currentView;
                renderModalFields();
            } else {
                document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit mr-2"></i>編輯資料';
                typeSel.disabled = true;
                const foundType = Object.keys(db).find(k => db[k].find(i => i.id === id));
                typeSel.value = foundType;
                renderModalFields(db[foundType].find(i => i.id === id));
            }
        }
        function closeModal() { document.getElementById('mainModal').classList.add('hidden');
            document.getElementById('mainModal').classList.remove('flex'); }

        function addShipmentRow(data = {}) {
            const container = document.getElementById('shipmentsContainer');
            const div = document.createElement('div');
            div.className = "flex gap-2 items-center mb-2 p-2 bg-white/5 rounded border border-white/5 shipment-row";
            const rnd = Math.random().toString(36).substring(7);
            const dateInputHtml = createDateInputGroup(`ship_date_${rnd}`, data.dueDate||'', 's-date-hidden');
            div.innerHTML = `
                <div class="flex-1"><label class="text-xs text-gray-500">需求交期</label>${dateInputHtml}</div>
                <div class="w-24"><label class="text-xs text-gray-500">數量</label><input type="number" class="input-dark s-qty" value="${data.qty||''}"></div>
                <div class="flex items-center pt-4"><label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" class="accent-orange-500 s-ship" ${data.isShipped?'checked':''}> 已出貨</label></div>
                <button onclick="this.parentElement.remove()" class="text-red-500 pt-4 px-2 hover:text-red-300"><i class="fas fa-times"></i></button>
     
            `;
            container.appendChild(div);
        }

        function updateTrackDate(startDateStr) {
            if(!startDateStr) return;
            const d = new Date(startDateStr);
            d.setDate(d.getDate() + 3);
            const iso = d.toISOString().split('T')[0];
            const trackHidden = document.getElementById('f_trackDate');
            if(trackHidden) {
                trackHidden.value = iso;
                const [y, m, d_val] = iso.split('-');
                const container = trackHidden.parentElement;
                container.querySelector('.yy').value = y;
                container.querySelector('.mm').value = m;
                container.querySelector('.dd').value = d_val;
            }
        }

        function autoFillProjectInfo(val) {
            if(!val) return;
            // 模糊對應：只要 Project 包含輸入值 (且長度足夠避免誤判) 就抓第一筆
            // 但為了精確，這裡先抓完全符合，若無則抓包含
            let match = db.masterList.find(m => m.project === val);
            if(!match && val.length > 3) match = db.masterList.find(m => (m.project||'').includes(val));
            if(match) {
                const setVal = (id, v) => { const el = document.getElementById(id);
                if(el) el.value = v || ''; };
                setVal('f_agent', match.agent);
                setVal('f_endUser', match.endUser);
                setVal('f_size', match.size);
                setVal('f_plm', match.plm);
                // 訂單、報價、任務 自動帶入 Model
                setVal('f_model', match.model);
            }
        }

        // 新增：透過 Model 反查 Project 與其他資訊
        function autoFillInfoByModel(val) {
            if(!val) return;
            // 在 MasterList 中尋找完全符合的 Model
            let match = db.masterList.find(m => m.model === val);
            // 若 MasterList 找不到，嘗試從案子列表找
            if(!match) match = db.projects.find(p => p.model === val);

            if(match) {
                const setVal = (id, v) => { const el = document.getElementById(id); if(el) el.value = v || ''; };
                setVal('f_project', match.project);
                setVal('f_agent', match.agent);
                setVal('f_endUser', match.endUser);
                setVal('f_size', match.size);
                setVal('f_plm', match.plm);
            }
        }

        // 新增：處理輸入框建議 (V3.8.1 修正：擴大模糊搜尋來源至全資料庫)
        function handleInputSuggestions(input, field) {
            const val = input.value.toLowerCase();
            const container = input.parentElement;
            // 清除舊建議
            const old = container.querySelector('.suggestion-list');
            if(old) old.remove();

            if(val.length < 1) return; // 修正：輸入 1 個字元即開始搜尋，提升反應速度

            let source = [];
            
            // 輔助函式：從所有相關資料表中提取指定欄位，確保資料來源完整
            const collect = (key) => {
                let arr = [];
                // 遍歷所有可能含有資料的表
                ['masterList', 'projects', 'orders', 'tasks', 'quotes', 'contacts', 'codes'].forEach(tbl => {
                    if(db[tbl]) arr = arr.concat(db[tbl].map(item => item[key]));
                });
                return arr;
            };

            // 根據欄位決定搜尋來源 (全面擴大來源，確保歷史資料也能被模糊搜尋到)
            if(field === 'project') source = collect('project');
            else if(field === 'model') source = collect('model');
            else if(field === 'agent') source = collect('agent');
            else if(field === 'endUser') source = collect('endUser');

            // 去除重複、移除空值、執行模糊比對 (使用 includes 達成輸入 '9611' 匹配 'OJ#9611002')
            const matches = [...new Set(source)].filter(s => s && s.toString().toLowerCase().includes(val)).slice(0, 10);
            
            if(matches.length > 0) {
                const ul = document.createElement('div');
                ul.className = 'suggestion-list';
                matches.forEach(m => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.innerText = m;
                    div.onclick = () => {
                        input.value = m;
                        ul.remove();
                        if(field === 'project') autoFillProjectInfo(m);
                        // 新增：若欄位是 model，則反查 project
                        if(field === 'model') autoFillInfoByModel(m);
                    };
                    ul.appendChild(div);
                });
                container.appendChild(ul);
            }
        }

        // V3.5.73: copyMasterToTask function removed.

        // V3.5.5 Fix: Added setTimeout to handleDateSegment to prevent auto-jump glitch
        function createDateInputGroup(id, value, extraClass = '') {
            let yVal = '', mVal = '', dVal = '';
            if (value) {
                const d = new Date(value);
                yVal = value.split('-')[0] || d.getFullYear();
                mVal = value.split('-')[1] || (d.getMonth() + 1).toString().padStart(2, '0');
                dVal = value.split('-')[2] || d.getDate().toString().padStart(2, '0');
            }

            return `
            <div class="date-segment-container">
                <input type="text" class="yy w-12" placeholder="YYYY" maxlength="4" value="${yVal}" oninput="handleDateSegment(this, 'y')" onfocus="this.select()">
                <span class="text-gray-500">/</span>
                <input type="text" class="mm w-8" placeholder="MM" maxlength="2" value="${mVal}" oninput="handleDateSegment(this, 'm')" onfocus="this.select()">
       
                 <span class="text-gray-500">/</span>
                <input type="text" class="dd w-8" placeholder="DD" maxlength="2" value="${dVal}" oninput="handleDateSegment(this, 'd')" onfocus="this.select()">
                <input type="hidden" id="${id}" class="${extraClass}" value="${value}">
            </div>`;
        }

        function handleDateSegment(el, type) {
            const container = el.parentElement;
            const val = el.value;
            
            // V3.5.5 Fix: Add timeout to prevent event bleeding when focus changes rapidly
            if (type === 'y' && val.length === 4) {
                setTimeout(() => container.querySelector('.mm').focus(), 50);
            } else if (type === 'm' && val.length === 2) {
                setTimeout(() => container.querySelector('.dd').focus(), 50);
            }

            const y = container.querySelector('.yy').value.padStart(4, '202');
            const m = container.querySelector('.mm').value.padStart(2, '0');
            const d = container.querySelector('.dd').value.padStart(2, '0');
            const fullDate = `${y}-${m}-${d}`;
            const hidden = container.querySelector('input[type=hidden]');
            hidden.value = fullDate;

            if (hidden.id === 'f_startDate') {
                updateTrackDate(fullDate);
            }
        }

        // V3.5.7: Task Completed Toggle
        function toggleTaskCompleteFields(checkbox) {
            const section = document.getElementById('taskCompleteSection');
            if(checkbox.checked) {
                section.classList.remove('hidden');
                // Auto popup specific comment hint
                const container = document.getElementById('commentsContainer');
                // Check if already exists
                const existing = Array.from(container.querySelectorAll('input[type=text]')).some(i => i.value === '針對任務採取了哪些行動');
                if(!existing) {
                    addCommentField();
                    // Select 'desc'
                    const lastRow = container.lastElementChild;
                    if(lastRow) {
                        const sel = lastRow.querySelector('select');
                        sel.value = 'desc';
                        const input = lastRow.querySelector('input');
                        input.value = '';
                        input.placeholder = '針對任務採取了哪些行動';
                        input.focus();
                    }
                }
            } else {
                section.classList.add('hidden');
            }
        }

        function renderModalFields(data = {}) {
            const type = document.getElementById('modalType').value;
            const container = document.getElementById('modalFields');
            const commContainer = document.getElementById('commentsContainer');
            
            commContainer.innerHTML = (data.comments || []).map((c, i) => `
                <div class="flex gap-2 mb-1">
                    <select class="input-dark text-xs w-1/3" onchange="updateComment(${i}, 'field', this.value)">
                         ${getAllFields(type).map(f => `<option value="${f.k}" ${f.k===c.field?'selected':''}>${f.l}</option>`).join('')}
                     </select>
                    <textarea class="input-dark text-xs flex-1 h-8 pt-1" onchange="updateComment(${i}, 'text', this.value)">${c.text}</textarea>
                    <button onclick="removeComment(${i})" class="text-red-500"><i class="fas fa-times"></i></button>
                </div>`).join('');
            const genCheckboxGroup = (id, options, currentVal) => {
                const vals = (currentVal || '').split(',');
                return `<div class="checkbox-group" id="${id}">${options.map(opt => `<label><input type="checkbox" value="${opt}" ${vals.includes(opt)?'checked':''}>${opt}</label>`).join('')}</div>`;
            };

            // 新增：定義觸發行為下拉選單的 HTML 生成函數
            const createTriggerSelect = (id, val) => `
                <div class="flex flex-col space-y-1">
                    <label class="text-xs text-orange-400 font-bold">⚠️ 觸發提醒行為</label>
                    <select id="${id}" class="input-dark text-sm border-orange-500/30 focus:border-orange-500">
                        <option value="">無</option>
                        <option value="QUOTES" ${val==='QUOTES'?'selected':''}>報價列表</option>
                        <option value="ORDERS" ${val==='ORDERS'?'selected':''}>訂單列表</option>
                        <option value="BOTH" ${val==='BOTH'?'selected':''}>兩者皆是</option>
                    </select>
                </div>`;

            let html = '';
            if(type === 'orders') {
                const defaultOrderDate = data.createdAt ||
                new Date().toISOString().split('T')[0];
                html = `
                    <div class="grid grid-cols-2 gap-4">
                        <div class="relative"><input class="input-dark" placeholder="Project" id="f_project" value="${data.project||''}" oninput="handleInputSuggestions(this, 'project'); autoFillProjectInfo(this.value)" autocomplete="off"></div>
                        <div class="relative"><input class="input-dark" placeholder="Agent" id="f_agent" value="${data.agent||''}" oninput="handleInputSuggestions(this, 'agent')" autocomplete="off"></div>
        
                        <div class="relative"><input class="input-dark" placeholder="End User" id="f_endUser" value="${data.endUser||''}" oninput="handleInputSuggestions(this, 'endUser')" autocomplete="off"></div>
                        <input class="input-dark" placeholder="PO#" id="f_po" value="${data.po||''}">
                        <div class="relative"><input class="input-dark" placeholder="Model" id="f_model" value="${data.model||''}" oninput="handleInputSuggestions(this, 'model')" autocomplete="off"></div>
               
                      </div>
                     <div class="bg-black/20 p-3 rounded mt-2 border border-white/5">
                         <div class="mb-2"><label class="text-orange-300 text-sm font-bold">訂單日期</label>${createDateInputGroup('f_orderDate', defaultOrderDate)}</div>
                          <div id="shipmentsContainer"></div>
          
                      <button onclick="addShipmentRow()" class="text-xs text-orange-400 
                         hover:text-white mt-2 font-bold flex items-center gap-1"><i class="fas fa-plus"></i> 追加交期/數量</button>
                    </div>
                    <textarea class="input-dark h-20 mt-2" placeholder="狀態說明" id="f_statusDesc">${data.statusDesc||''}</textarea>
    
                `;
                setTimeout(() => {
                    const ships = data.shipments && data.shipments.length ? data.shipments : (data.qty ? [{dueDate:data.dueDate, qty:data.qty, isShipped:data.isShipped}] : []);
                    if(ships.length === 0) addShipmentRow(); 
                    else ships.forEach(s => addShipmentRow(s));
                
                }, 0);
            } else if(type === 'projects') {
                html = `
                    <div class="grid grid-cols-3 gap-4">
                        <div class="relative suggestion-container"><input class="input-dark" placeholder="Project (必填)" id="f_project" value="${data.project||''}" oninput="handleInputSuggestions(this, 'project'); autoFillProjectInfo(this.value)" autocomplete="off"></div>
                 
                       <div class="relative suggestion-container"><input class="input-dark" placeholder="Agent" id="f_agent" value="${data.agent||''}" oninput="handleInputSuggestions(this, 'agent')" autocomplete="off"></div>
                        <div class="relative suggestion-container"><input class="input-dark" placeholder="End User" id="f_endUser" value="${data.endUser||''}" oninput="handleInputSuggestions(this, 'endUser')" autocomplete="off"></div>
                        <input class="input-dark" placeholder="Size" id="f_size" value="${data.size||''}">
                      
                         <div class="relative suggestion-container"><input class="input-dark text-model" placeholder="Model" id="f_model" value="${data.model||''}" oninput="handleInputSuggestions(this, 'model')" autocomplete="off"></div>
                        <input class="input-dark" type="number" placeholder="當年預算" id="f_budget" value="${data.budget||''}">
                        <input class="input-dark" placeholder="PLM#" id="f_plm" value="${data.plm||''}">
                    </div>
           
                        <div class="bg-black/20 p-3 rounded mt-2 border border-white/5">
                        <label class="text-xs text-orange-300 block mb-2">最新動態 (手動覆蓋)</label>
                        <div class="flex gap-4">
                              
                                 <div class="flex-1">${genCheckboxGroup('grp_latestStatus', ['訂單','報價','RMA','規格','送樣'], data.manualLatestStatus)}</div>
                                <div>${createDateInputGroup('f_manualLatestDate', data.manualLatestDate ||
                                new Date().toISOString().split('T')[0])}</div>
                        </div>
                    </div>
                    <div class="bg-black/20 p-3 rounded mt-2 border border-white/5">
                        <label class="text-xs text-orange-300 block mb-2">標籤</label>
 
                        ${genCheckboxGroup('grp_tags', ['量產','送樣','RMA','報價','規格'], data.tags)}
                    </div>
                    <textarea class="input-dark h-20 mt-2" placeholder="狀況概述" id="f_summary">${data.summary||''}</textarea>
                    <label class="flex items-center gap-2 mt-2"><input type="checkbox" id="f_active" ${data.active!==false?'checked':''} 
 
                   class="accent-orange-500"> Active</label>
              `;
            } else if(type === 'masterList') {
                const safe = (v) => (v || '').toString().replace(/"/g, '&quot;');
                html = `
                     <div class="grid grid-cols-3 gap-4">
                        <div class="relative"><input class="input-dark" placeholder="Project" id="f_project" value="${safe(data.project)}" oninput="handleInputSuggestions(this, 'project'); autoFillProjectInfo(this.value)" autocomplete="off"></div>
                       <div class="relative"><input class="input-dark" placeholder="Agent" id="f_agent" value="${safe(data.agent)}" oninput="handleInputSuggestions(this, 'agent')" autocomplete="off"></div>
                        <div class="relative"><input class="input-dark" placeholder="End User" id="f_endUser" value="${safe(data.endUser)}" oninput="handleInputSuggestions(this, 'endUser')" autocomplete="off"></div>
                        <input class="input-dark" placeholder="Application" id="f_application" value="${safe(data.application)}">
                        <input class="input-dark" placeholder="EAU" id="f_eau" value="${safe(data.eau)}">
                        <input class="input-dark" placeholder="Size" id="f_size" value="${safe(data.size)}">
                        <div class="relative"><input class="input-dark" placeholder="Model" id="f_model" value="${safe(data.model)}" oninput="handleInputSuggestions(this, 'model')" autocomplete="off"></div>
                        <input class="input-dark" placeholder="Price" id="f_salesPrice" value="${safe(data.salesPrice)}">
                            <input class="input-dark" placeholder="Contact" id="f_contact" 
                         value="${safe(data.contact)}">
                        <input class="input-dark" placeholder="Cus PN" id="f_cusPN" value="${safe(data.cusPN)}">
                       <input class="input-dark" placeholder="PLM#" id="f_plm" value="${safe(data.plm)}">
                     </div>

                    <div class="bg-black/20 p-3 rounded mt-2 border border-white/5">
                        <label class="text-xs text-orange-300 block mb-2">標籤</label>
                        ${genCheckboxGroup('grp_tags', ['量產','送樣','RMA','報價','規格'], data.tags)}
                    </div>

                    <textarea class="input-dark h-20 mt-2" placeholder="Remark" id="f_remark">${data.remark||''}</textarea>
                    
                    <div class="border-t border-gray-700 pt-3 mt-2 grid grid-cols-3 gap-4">
                        <div class="col-span-1">
                            ${createTriggerSelect('f_triggerAction', data.triggerAction)}
                        </div>
                        <div class="col-span-2">
                            <label class="text-xs text-orange-400 font-bold">提醒說明內容</label>
                            <input type="text" id="f_triggerDesc" class="input-dark text-sm w-full" 
                                placeholder="當觸發時顯示的提醒訊息..." 
                                value="${data.triggerDesc || ''}">
                        </div>
                    </div>

                    <label class="flex items-center gap-2 mt-2"><input type="checkbox" id="f_active" ${data.active!==false?'checked':''} class="accent-orange-500"> Active</label>
        
                `;
            } else if (type === 'tasks') {
                const defStart = data.startDate ||
                new Date().toISOString().split('T')[0];
                let defTrack = data.trackDate || '';
                if(!editingId && !defTrack) {
                    const d = new Date(defStart);
                    d.setDate(d.getDate()+3);
                    defTrack = d.toISOString().split('T')[0];
                }
                const defCompDate = data.completedDate ||
                new Date().toISOString().split('T')[0];

                html = `<div class="grid grid-cols-2 gap-4">
                    <div class="relative suggestion-container">
                        <input class="input-dark" placeholder="Project" id="f_project" value="${data.project||''}" oninput="handleInputSuggestions(this, 'project'); autoFillProjectInfo(this.value)" 
                        autocomplete="off">
               
                    </div>
                    <select class="input-dark" id="f_taskType">${['詢價','RMA','規格','送樣','交期','預測','合約','其他'].map(o=>`<option ${data.taskType===o?'selected':''}>${o}</option>`).join('')}</select>
                    
                    <div class="relative suggestion-container"><input class="input-dark" placeholder="Agent" id="f_agent" value="${data.agent||''}" oninput="handleInputSuggestions(this, 'agent')" autocomplete="off"></div>
                    <div class="relative suggestion-container"><input 
                    class="input-dark" placeholder="End User" id="f_endUser" value="${data.endUser||''}" oninput="handleInputSuggestions(this, 'endUser')" autocomplete="off"></div>
                    
                    <div class="col-span-2 relative suggestion-container">
                         <input class="input-dark text-model" placeholder="Model (自動帶入)" id="f_model" value="${data.model||''}" oninput="handleInputSuggestions(this, 'model')" autocomplete="off">
                
                    </div>
                  
                  <div><label class="text-xs text-gray-400">起始</label>${createDateInputGroup('f_startDate', defStart)}</div>
                    <div><label class="text-xs text-gray-400">追蹤 (起始+3天)</label>${createDateInputGroup('f_trackDate', defTrack)}</div>
                  <input class="input-dark" placeholder="文件#" id="f_docNum" value="${data.docNum||''}"></div>
           
                    <textarea class="input-dark h-20" placeholder="說明" id="f_desc">${data.desc||''}</textarea>
     
                    ${editingId?`
                    <div class="mt-2 border-t border-white/10 pt-2">
                        <label class="flex items-center gap-2"><input type="checkbox" id="f_completed" ${data.completed?'checked':''} class="accent-orange-500" onchange="toggleTaskCompleteFields(this)"> 已完成</label>
     
                       <div id="taskCompleteSection" class="${data.completed?'':'hidden'} mt-2 p-2 border border-green-500/30 rounded bg-green-900/10 space-y-3">
                            <div>
                                <label class="text-xs text-green-400 block mb-1">完成日期</label>
        
                                ${createDateInputGroup('f_completedDate', defCompDate)}
                            </div>
                            
                   
                            <div class="border-t border-green-500/30 pt-2">
                                <label class="flex items-center gap-2 mb-2 cursor-pointer">
                                    <input type="checkbox" id="f_followUp" class="accent-orange-500" onchange="document.getElementById('followUpDetails').classList.toggle('hidden', !this.checked)"> 
         
                                   <span class="text-sm text-green-300 font-bold">後續追蹤</span>
                                </label>
                                <div id="followUpDetails" class="hidden pl-2 border-l-2 border-green-500/50 
                                space-y-2">
                                    <div>
                                        <label class="text-xs text-gray-400">起始日期 (自動推算追蹤日+3天)</label>
                     
                                       ${createDateInputGroup('f_followUpDate', new Date().toISOString().split('T')[0])}
                                    </div>
                                    <textarea id="f_followUpDesc" class="input-dark text-sm h-20" placeholder="後續任務說明..."></textarea>
  
                                 </div>
                            </div>
                        </div>
                  
                </div>`:''}`;
            } else if (type === 'quotes') {
                html = `<div class="grid grid-cols-2 gap-4">
                    <div class="relative"><input class="input-dark" placeholder="Project" id="f_project" value="${data.project||''}" oninput="handleInputSuggestions(this, 'project'); autoFillProjectInfo(this.value)" autocomplete="off"></div>
                    <div class="relative"><input class="input-dark" placeholder="Agent" id="f_agent" value="${data.agent||''}" oninput="handleInputSuggestions(this, 'agent')" autocomplete="off"></div>
               
                    <div class="relative"><input class="input-dark" placeholder="End User" id="f_endUser" value="${data.endUser||''}" oninput="handleInputSuggestions(this, 'endUser')" autocomplete="off"></div>
                    <div class="relative"><input class="input-dark" placeholder="Model" id="f_model" value="${data.model||''}" oninput="handleInputSuggestions(this, 'model')" autocomplete="off"></div>
         
                   <div><label class="text-xs text-gray-400">日期</label>${createDateInputGroup('f_date', data.date||new Date().toISOString().split('T')[0])}</div>
            
                     <textarea class="input-dark h-16" placeholder="業務報價 (Enter 換行)" 
                    id="f_salesPrice">${data.salesPrice||''}</textarea>
                    <textarea class="input-dark h-16" placeholder="FAE報價 (Enter 換行)" id="f_faePrice">${data.faePrice||''}</textarea>
                    <input class="input-dark" placeholder="REF#" id="f_ref" value="${data.ref||''}"></div>
     
                    <textarea class="input-dark h-16 mt-2" placeholder="產品結構描述" id="f_productStructure">${data.productStructure||''}</textarea>

          <textarea class="input-dark h-20 mt-2" placeholder="說明" id="f_desc">${data.desc||''}</textarea>`;
            } else if (type === 'contacts') {
                html = `<div class="grid grid-cols-2 gap-4">
                    <div class="relative suggestion-container"><input class="input-dark" placeholder="Agent" id="f_agent" value="${data.agent||''}" oninput="handleInputSuggestions(this, 'agent')" autocomplete="off"></div>
                    <div class="relative suggestion-container"><input class="input-dark" 
                    
                    placeholder="End User" id="f_endUser" value="${data.endUser||''}" oninput="handleInputSuggestions(this, 'endUser')" autocomplete="off"></div>
                    
                    <input class="input-dark" placeholder="Name" id="f_name" value="${data.name||''}">
                    <input class="input-dark" placeholder="Email" id="f_email" value="${data.email||''}">
                    
      
                      <input class="input-dark" placeholder="Position" id="f_position" value="${data.position||''}">
                    <input class="input-dark" placeholder="Phone" id="f_phone" value="${data.phone||''}">
                    <input class="input-dark col-span-2" placeholder="Address" id="f_address" value="${data.address||''}"></div>
                    <textarea class="input-dark h-16" placeholder="Remark" id="f_remark">${data.remark||''}</textarea><label class="flex items-center gap-2"><input type="checkbox" id="f_active" ${data.active!==false?'checked':''} class="accent-orange-500"> Active</label>`;
            } else if (type === 'codes') {
                html = `<div class="grid grid-cols-2 gap-4">
                    <div class="relative"><input class="input-dark" placeholder="Agent" id="f_agent" value="${data.agent||''}" oninput="handleInputSuggestions(this, 'agent')" autocomplete="off"></div>
                    <div class="relative"><input class="input-dark" placeholder="End User" id="f_endUser" value="${data.endUser||''}" oninput="handleInputSuggestions(this, 'endUser')" autocomplete="off"></div>
                
                    <input class="input-dark" placeholder="Code" id="f_code" value="${data.code||''}">
                    <input class="input-dark" placeholder="Pricing" id="f_pricing" value="${data.pricing||''}">
                    <input class="input-dark" placeholder="Logistics" id="f_logistics" value="${data.logistics||''}"></div>
                    <textarea class="input-dark h-16" placeholder="Remark" id="f_remark">${data.remark||''}</textarea>
                    
                    <div class="border-t border-gray-700 pt-3 mt-2 grid grid-cols-3 gap-4">
                        <div class="col-span-1">
                            ${createTriggerSelect('f_triggerAction', data.triggerAction)}
                        </div>
                        <div class="col-span-2">
                            <label class="text-xs text-orange-400 font-bold">提醒說明內容</label>
                            <input type="text" id="f_triggerDesc" class="input-dark text-sm w-full" 
                                placeholder="當觸發時顯示的提醒訊息..." 
                                value="${data.triggerDesc || ''}">
                        </div>
                    </div>

                    <label class="flex items-center gap-2"><input type="checkbox" id="f_active" ${data.active!==false?'checked':''} class="accent-orange-500"> Active</label>`;
            }
            container.innerHTML = html;
        }
        function getAllFields(type) {
            const map = {
                'projects': [{k:'project',l:'Project'},{k:'agent',l:'Agent'},{k:'endUser',l:'End User'},{k:'size',l:'Size'},{k:'model',l:'Model'},{k:'summary',l:'狀況概述'},{k:'budget',l:'當年預算'},{k:'plm',l:'PLM#'}],
                'masterList': [{k:'project',l:'Project'},{k:'agent',l:'Agent'},{k:'endUser',l:'End User'},{k:'application',l:'App'},{k:'eau',l:'EAU'},{k:'size',l:'Size'},{k:'model',l:'Model'},{k:'salesPrice',l:'Price'},{k:'remark',l:'Remark'},{k:'contact',l:'Contact'},{k:'cusPN',l:'Cus PN'},{k:'plm',l:'PLM#'}],
                'tasks': [{k:'project',l:'Project'},{k:'agent',l:'Agent'},{k:'model',l:'Model'},{k:'taskType',l:'任務'},{k:'desc',l:'說明'},{k:'docNum',l:'文件#'}],
                'quotes': [{k:'project',l:'Project'},{k:'salesPrice',l:'業務報價'},{k:'faePrice',l:'FAE報價'},{k:'ref',l:'REF#'},{k:'desc',l:'說明'},{k:'model',l:'Model'}],
    
                'contacts': [{k:'agent',l:'Agent'},{k:'name',l:'Name'},{k:'email',l:'Email'},{k:'address',l:'Address'},{k:'phone',l:'Phone'},{k:'remark',l:'Remark'}],
                'codes': [{k:'code',l:'Code'},{k:'pricing',l:'Pricing'},{k:'logistics',l:'Logistics'},{k:'remark',l:'Remark'}],
                'orders': [{k:'po',l:'PO#'},{k:'statusDesc',l:'狀態說明'},{k:'model',l:'型號'},{k:'orderDate',l:'訂單日期'}]
            };
            return map[type] || [];
        }

        function addCommentField() {
            const type = document.getElementById('modalType').value;
            const container = document.getElementById('commentsContainer');
            const div = document.createElement('div');
            div.className = "flex gap-2 mb-1";
            div.innerHTML = `<select class="input-dark text-xs w-1/3">${getAllFields(type).map(f => `<option value="${f.k}">${f.l}</option>`).join('')}</select><textarea class="input-dark text-xs flex-1 h-8 pt-1"></textarea><button onclick="this.parentElement.remove()" class="text-red-500"><i class="fas fa-times"></i></button>`;
            container.appendChild(div);
        }

        // ==========================================
        // V3.8.1 提醒攔截功能 (Trigger Action) 核心邏輯
        // ==========================================
        
        // 用來暫存待儲存的資料與執行動作
        let pendingSavePayload = null;
        let pendingSaveCallback = null;

        // 檢查是否有提醒事項
        function checkReminders(data) {
            const reminders = [];
            // 只在「報價」與「訂單」介面觸發
            const isQuote = document.getElementById('modalType').value === 'quotes';
            const isOrder = document.getElementById('modalType').value === 'orders';
            
            if (!isQuote && !isOrder) return [];

            // 1. 檢查代碼表 (Codes) - 比對 Agent 或 End User
            const agentVal = (data.agent || '').trim();
            const endUserVal = (data.endUser || '').trim();
            
            if (agentVal || endUserVal) {
                db.codes.forEach(c => {
                    // 檢查是否設定了觸發
                    if (!c.triggerAction) return;
                    
                    // 檢查觸發類型是否符合當前視圖 (QUOTES, ORDERS, BOTH)
                    const actionMatch = 
                        (c.triggerAction === 'BOTH') ||
                        (isQuote && c.triggerAction === 'QUOTES') ||
                        (isOrder && c.triggerAction === 'ORDERS');
                    
                    if (actionMatch) {
                        // 檢查名稱是否匹配 (Agent 或 End User 擇一匹配即觸發)
                        const nameMatch = 
                            (agentVal && c.agent === agentVal) || 
                            (endUserVal && c.endUser === endUserVal);

                        if (nameMatch) {
                            reminders.push({
                                type: '客戶代碼提醒',
                                source: `${c.agent || c.endUser}`,
                                desc: c.triggerDesc || '無說明內容'
                            });
                        }
                    }
                });
            }

            // 2. 檢查總表 (Master List) - 比對 Model
            const modelVal = (data.model || '').trim();
            if (modelVal) {
                db.masterList.forEach(m => {
                    if (!m.triggerAction) return;
                    
                    const actionMatch = 
                        (m.triggerAction === 'BOTH') ||
                        (isQuote && m.triggerAction === 'QUOTES') ||
                        (isOrder && m.triggerAction === 'ORDERS');
                    
                    if (actionMatch && m.model === modelVal) {
                        reminders.push({
                            type: '總表型號提醒',
                            source: m.model,
                            desc: m.triggerDesc || '無說明內容'
                        });
                    }
                });
            }

            return reminders;
        }

        // 開啟提醒視窗
        function showReminderModal(reminders) {
            const contentDiv = document.getElementById('reminderContent');
            contentDiv.innerHTML = reminders.map(r => `
                <div class="mb-3 pb-3 border-b border-gray-700 last:border-0">
                    <div class="text-orange-400 font-bold mb-1 text-xs">[${r.type}] ${r.source}</div>
                    <div class="text-white text-base">${r.desc}</div>
                </div>
            `).join('');
            
            const modal = document.getElementById('reminderModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeReminderModal() {
            const modal = document.getElementById('reminderModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            // 清除暫存
            pendingSavePayload = null;
            pendingSaveCallback = null;
        }

        // 確認儲存 (觸發特效並執行實際儲存)
        function confirmSave() {
            // 關閉提醒視窗
            const modal = document.getElementById('reminderModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');

            // 顯示綠色光暈特效 Toast
            const toast = document.getElementById('confirmedToast');
            toast.classList.remove('hidden');
            toast.classList.add('flex');
            
            // 動畫進場
            setTimeout(() => {
                toast.classList.remove('opacity-0', 'scale-90');
                toast.classList.add('opacity-100', 'scale-100');
            }, 50);

            // 1秒後執行儲存並移除特效
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'scale-100');
                toast.classList.add('opacity-0', 'scale-90');
                
                setTimeout(() => {
                    toast.classList.add('hidden');
                    toast.classList.remove('flex');
                    
                    // 執行原本的儲存邏輯
                    if (pendingSaveCallback) {
                        pendingSaveCallback();
                    }
                }, 300); // 等待淡出動畫結束
            }, 1000); // 顯示特效的時間
        }

        function saveData() {
            const type = document.getElementById('modalType').value;
            const inputs = document.querySelectorAll('#modalFields input:not([type=checkbox]):not(.s-qty):not(.yy):not(.mm):not(.dd), #modalFields select, #modalFields textarea');
            const newData = { id: editingId || Date.now(), updatedAt: new Date() };
            
            inputs.forEach(input => { 
                const key = input.id.replace('f_', ''); 
                if(key && key.indexOf('ship_date') === -1) { 
                    newData[key] = input.value; 
                }
            });
            document.querySelectorAll('#modalFields input[type=checkbox]:not(.group-check):not(.s-ship)').forEach(cb => { if(!cb.closest('.checkbox-group')) newData[cb.id.replace('f_', '')] = cb.checked; });
            // 修正：MasterList 也要儲存 Tags
            if (type === 'projects' || type === 'masterList') {
                const getGroupVal = (id) => Array.from(document.querySelectorAll(`#${id} input:checked`)).map(c=>c.value).join(',');
                newData.tags = getGroupVal('grp_tags');
                
                if (type === 'projects') {
                    newData.manualLatestStatus = getGroupVal('grp_latestStatus');
                    newData.manualLatestDate = document.getElementById('f_manualLatestDate').value;
                }
            }
            if (type === 'orders') {
                newData.createdAt = document.getElementById('f_orderDate').value;
                newData.shipments = [];
                document.querySelectorAll('.shipment-row').forEach(row => {
                    const hiddenDate = row.querySelector('.s-date-hidden').value;
                    newData.shipments.push({
                        dueDate: hiddenDate,
                        qty: row.querySelector('.s-qty').value,
                        isShipped: row.querySelector('.s-ship').checked
                    });
                });
            }
            if (type === 'tasks' && newData.completed) {
                const compDate = document.getElementById('f_completedDate');
                if(compDate) newData.completedDate = compDate.value;

                const followUpCheck = document.getElementById('f_followUp');
                if(followUpCheck && followUpCheck.checked) {
                    const fuDate = document.getElementById('f_followUpDate').value;
                    const fuDesc = document.getElementById('f_followUpDesc').value;
                    const d = new Date(fuDate);
                    d.setDate(d.getDate() + 3);
                    const fuTrack = d.toISOString().split('T')[0];

                    const newTask = {
                        id: Date.now() + 100, 
                        updatedAt: new Date(),
                        project: newData.project,
                        agent: newData.agent,
                        endUser: newData.endUser,
                        model: newData.model,
                        taskType: newData.taskType, 
                        startDate: fuDate,
                        trackDate: fuTrack,
                        desc: fuDesc || '後續追蹤',
                        docNum: '',
                        active: true,
                        comments: []
                    };
                    db.tasks.push(newTask);
                }
            }
            
            if(['projects','masterList','orders','quotes'].includes(type) && !newData.project) return alert('Project 為必填');
            
            const commentDivs = document.querySelectorAll('#commentsContainer > div');
            newData.comments = Array.from(commentDivs).map(div => ({ field: div.querySelector('select').value, text: div.querySelector('textarea').value })).filter(c => c.text);
            
            if(type === 'projects') {
                 const hasOrder = db.orders.some(o => o.project === newData.project);
                 if(hasOrder) {
                     let currentTags = newData.tags ? newData.tags.split(',') : [];
                     if(!currentTags.includes('訂單')) {
                         currentTags.push('訂單');
                        newData.tags = currentTags.join(',');
                     }
                 }
            }

            // =========================
            // 定義實際的儲存動作 (Closure)
            const performSave = () => {
                if(editingId) {
                    const idx = db[type].findIndex(i => i.id === editingId);
                    if(idx >= 0) db[type][idx] = { ...db[type][idx], ...newData };
                } else { 
                    db[type].push(newData);
                }
                saveToLocal(); closeModal(); renderCurrentView();
                
                // 顯示一般成功訊息 (如果不是透過確認視窗觸發的)
                if (!document.getElementById('confirmedToast').classList.contains('flex')) {
                   
                   // 修正：移除 [總表維護]、[客戶代碼]、[聯絡人清單] 的一般存檔提示
                   if (type !== 'masterList' && type !== 'codes' && type !== 'contacts') {
                       const toast = document.getElementById('actionToast');
                       toast.querySelector('h3').innerText = editingId ? '已更新資料' : '已新增資料';
                       
                       // 修正：手動存檔時，隱藏「當年預算預設為 EAU」這行說明文字，避免誤導
                       const pTag = toast.querySelector('p');
                       if(pTag) pTag.style.display = 'none';

                       toast.style.display = 'block';
                       setTimeout(() => toast.style.display = 'none', 2000);
                   }
                }
            };

            // =========================
            // 核心攔截邏輯
            // =========================
            const reminders = checkReminders(newData);
            if (reminders.length > 0) {
                // 暫存動作
                pendingSavePayload = newData;
                pendingSaveCallback = performSave;
                // 顯示確認視窗
                showReminderModal(reminders);
            } else {
                // 無提醒，直接儲存
                performSave();
            }
        }

        function deleteItem(id) { if(confirm('確定刪除?')) { const t = currentView==='activities'?'tasks':currentView; db[t] = db[t].filter(i=>i.id!==id);
        saveToLocal(); renderCurrentView(); } }
        function autoCheckShipment() { const today = new Date().toISOString().split('T')[0];
        db.orders.forEach(o => { 
                if(o.shipments) o.shipments.forEach(s => { if(!s.isShipped && s.dueDate && s.dueDate < today) s.isShipped = true; });
                else if(!o.isShipped && o.dueDate && o.dueDate < today) o.isShipped = true; 
            });
        saveToLocal();
        }

        function handleExcelImport(e) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                const data = evt.target.result;
                const wb = XLSX.read(data, {type:'binary', cellStyles: true}); 
                let count = 0;
                const sheetMapping = { '案子列表':'projects', '報價列表':'quotes', '聯絡人清單':'contacts', '客戶代碼與行為':'codes', '總表維護':'masterList' };
                for (const [sheetName, dbKey] of Object.entries(sheetMapping)) {
                    if (wb.SheetNames.includes(sheetName)) {
                        const sheet = wb.Sheets[sheetName];
                        const rawData = XLSX.utils.sheet_to_json(sheet, { defval: "" });
                        const colMap = {};
                        if(sheet['!ref']) {
                            const range = XLSX.utils.decode_range(sheet['!ref']);
                            for(let C = range.s.c; C <= range.e.c; ++C) {
                                const addr = XLSX.utils.encode_cell({r:range.s.r, c:C});
                                const cell = sheet[addr];
                                if(cell && cell.v) colMap[C] = cell.v.toString().trim();
                            }
                        }

                        rawData.forEach((row, rowIndex) => {
                            let newItem = { id: Date.now() + Math.random(), updatedAt: new Date(), comments: [] };
        
                            const excelRow = (XLSX.utils.decode_range(sheet['!ref']).s.r) + 1 + rowIndex + 1;

                            for (const key in row) {
                              
                                const k = key.toLowerCase().replace(/[\s#]/g, '');
  
                                let fieldName = '';
                                if(k.includes('project')) { newItem.project = row[key]; fieldName = 'project'; }
                 
                                else if(k.includes('agent')) { newItem.agent = row[key]; fieldName = 'agent'; }
                                else if(k.includes('enduser')) { newItem.endUser = row[key]; fieldName = 'endUser'; }
        
                                else if(k.includes('model')) { newItem.model = row[key]; fieldName = 'model';
                                }
    
                                else if(k.includes('size')) { newItem.size = row[key];
                                fieldName = 'size'; }
                                else if(k.includes('eau')) { newItem.eau = row[key];
                                fieldName = 'eau'; }
                                else if(k.includes('app')) { newItem.application = row[key];
                                fieldName = 'application'; }
                                else if(k.includes('contact')) { newItem.contact = row[key];
                                fieldName = 'contact'; }
                                else if(k.includes('plm')) { newItem.plm = row[key];
                                fieldName = 'plm'; }
                                else if(k.includes('業務報價') || (k.includes('price') && !k.includes('fae'))) { newItem.salesPrice = row[key];
                                fieldName = 'salesPrice'; }
                                else if(k.includes('fae') || k.includes('faeprice')) { newItem.faePrice = row[key];
                                fieldName = 'faePrice'; }
                                else if(k.includes('phone')) { newItem.phone = row[key];
                                fieldName = 'phone'; }
                                else if(k.includes('address')) { newItem.address = row[key];
                                fieldName = 'address'; }
                                else if(k.includes('name')) { newItem.name = row[key]; fieldName = 'name'; }
                                else if(k.includes('email')) { newItem.email = row[key]; fieldName = 'email'; }
                                else if(k.includes('code')) { newItem.code = row[key];
                                fieldName = 'code'; }
                                else if(k.includes('remark')) { newItem.remark = row[key];
                                fieldName = 'remark'; }
                                else if(k.includes('cuspn')) { newItem.cusPN = row[key];
                                fieldName = 'cusPN'; }
                                else if(k.includes('budget')) { newItem.budget = row[key];
                                fieldName = 'budget'; }

                                const colIdx = Object.keys(colMap).find(idx => colMap[idx] === key);
                                if (colIdx && fieldName) {
                                    const cellAddr = XLSX.utils.encode_cell({c: parseInt(colIdx), r: excelRow - 1});
                                    const cell = sheet[cellAddr];
                                    if(cell && (cell.c || cell.comment)) {
                                        const c = cell.c ||
                                        cell.comment;
                                        const commentText = Array.isArray(c) ? c.map(i=>i.t).join('\n') : (c.t || c);
                                        if(commentText) newItem.comments.push({ field: fieldName, text: commentText });
                                    }
                                }
                            }
                            
                            let existIdx = -1;
                            if(dbKey === 'projects' || dbKey === 'masterList' || dbKey === 'quotes') {
                                existIdx = db[dbKey].findIndex(x => x.project === newItem.project);
                            } else if (dbKey === 'codes') {
                                existIdx = db[dbKey].findIndex(x => x.code === newItem.code);
                            }
                            
                            if (existIdx > -1) {
                                db[dbKey][existIdx] = newItem;
                            } else {
                                db[dbKey].push(newItem);
                            }
                            count++;
                        });
                    }
                }
                saveToLocal();
                renderCurrentView(); alert(`成功匯入 ${count} 筆資料`);
            };
            reader.readAsBinaryString(e.target.files[0]);
        }

        // 新增：匯出視窗控制函式
        function openExportModal() {
            document.getElementById('exportModal').classList.remove('hidden');
            document.getElementById('exportModal').classList.add('flex');
        }
        function closeExportModal() {
            document.getElementById('exportModal').classList.add('hidden');
            document.getElementById('exportModal').classList.remove('flex');
        }

        // 修改：exportExcel 支援 timeRange 參數
        // 修改：exportExcel 支援 timeRange 參數，並包含 User 與 HHMM 資訊
        function exportExcel(mode, timeRange) {
            const wb = XLSX.utils.book_new();
            
            // 1. 取得時間 YYYYMMDD_HHMM
            const now = new Date();
            const YYYY = now.getFullYear();
            const MM = String(now.getMonth() + 1).padStart(2, '0');
            const DD = String(now.getDate()).padStart(2, '0');
            const HH = String(now.getHours()).padStart(2, '0');
            const MIN = String(now.getMinutes()).padStart(2, '0');
            const dateStr = `${YYYY}${MM}${DD}_${HH}${MIN}`;

            // 2. 取得當前使用者名稱
            const currentP = profileMeta.list.find(p => p.id === profileMeta.currentId) || { name: 'User' };
            const safeName = currentP.name.replace(/[\s\/\\]/g, '_');

            // 日期格式化小工具 (YYYY-MM-DD -> YYYY/MM/DD)
            const fmtDate = (d) => d ? d.toString().replace(/-/g, '/') : '';

            const processSheet = (ws, data) => {
                ws['!cols'] = Object.keys(data[0]||{}).map(() => ({wch: 15}));
                // [最終設定] 採用最相容的簡化凍結參數
                ws['!freeze'] = { xSplit: 0, ySplit: 1, topLeftCell: "A2", state: "frozen" };
                const range = XLSX.utils.decode_range(ws['!ref']);
                for(let R = range.s.r; R <= range.e.r; ++R) {
                    for(let C = range.s.c; C <= range.e.c; ++C) {
                        const cellAddr = XLSX.utils.encode_cell({r:R, c:C});
                        const cell = ws[cellAddr];
                        if(!cell) continue;

                        if(!cell.s) cell.s = {};
                        cell.s.alignment = { wrapText: true, vertical: 'top' };
                        cell.s.font = { name: "Arial", sz: 10 };
                        
                        if(R === 0) { 
                            cell.s.font = { name: "Arial", sz: 11, bold: true, color: { rgb: "0B5394" } };
                            cell.s.border = { bottom: { style: "thick", color: { rgb: "FFC000" } } };
                            cell.s.alignment = { horizontal: 'center', vertical: 'center', wrapText: true };
                        } else {
                            const item = data[R-1];
                            const headerCell = ws[XLSX.utils.encode_cell({r:0, c:C})];
                            const headerName = headerCell ? headerCell.v : '';
                            if(item && item._comments) {
                                const mapping = {
                                    'Project':'project','Agent':'agent','End User':'endUser','Model':'model',
                                    'Size':'size','EAU':'eau','Application':'application','Contact':'contact',
                                    'PLM#':'plm','Price':'salesPrice','Sales Price':'salesPrice','FAE Price':'faePrice',
                                    'Phone':'phone','Address':'address','Code':'code','Remark':'remark',
                                    'Cus PN':'cusPN','當年預算':'budget','狀況概述':'summary'
                                    };
                                const fieldKey = mapping[headerName];
                                const cmt = item._comments.find(c => c.field === fieldKey);
                                if(cmt) {
                                    // [強力修正] 雙重鎖定隱藏與重置樣式
                                    const commentObj = { t: cmt.text, a: "System", hidden: true };
                                    const commentsArray = [commentObj];
                                    commentsArray.hidden = true;
                                    cell.c = commentsArray;
                                    if(cell.comment) delete cell.comment;
                                }
                            }
                        }
                    }
                }
                return ws;
            };

            if(mode === 'LIST') {
                const addSheet = (name, rawData) => {
                    const ws = XLSX.utils.json_to_sheet(rawData);
                    processSheet(ws, rawData);
                    XLSX.utils.book_append_sheet(wb, ws, name);
                };

                // 1. Projects
                const projData = db.projects.map(p => {
                    const lastQuote = db.quotes.filter(q=>q.project===p.project).sort((a,b)=>new Date(b.date)-new Date(a.date))[0];
                    const tasks = db.tasks.filter(t => t.project === p.project).sort((a,b)=>new Date(b.trackDate||b.startDate)-new Date(a.trackDate||a.startDate));
                 
                    const remarkStr = tasks.map(t => `${fmtDate(t.trackDate||t.startDate)} ${t.taskType}: ${t.desc}`).join('\r\n');
                    const ach = calculateAchievement(p);

                    return {
                        'Project': p.project, 'Agent': p.agent, 'End User': p.endUser, 
                        'Size': p.size, 'Model': p.model, 
                        'Price': lastQuote ? lastQuote.salesPrice : '',
                        '達成數量': `${ach.qty} / ${p.budget||0}`,
                        '達成率': ach.percent,
                        '狀況概述': p.summary || '',
                        'Remark': remarkStr, '_comments': p.comments 
                    };
                });
                addSheet("案子列表", projData);

                // 2. Master List
                const masterData = db.masterList.map(m => {
                    const lastQuote = db.quotes.filter(q=>q.project===m.project).sort((a,b)=>new Date(b.date)-new Date(a.date))[0];
                    return {
                        'Project': m.project, 'Agent': m.agent, 'End User': m.endUser,
                        'Application': m.application, 'EAU': m.eau, 'Size': m.size,
                        'Model': m.model, 
                        'Price': lastQuote ? lastQuote.salesPrice : m.salesPrice, 
                        'Remark': m.remark,
                        'Contact': m.contact, 'Cus PN': m.cusPN, 'PLM#': m.plm, '_comments': m.comments
                    };
                });
                addSheet("總表維護", masterData);

                // 3. Quotes
                const quoteData = db.quotes.map(q => ({
                    'Project': q.project, 'Agent': q.agent, 'End User': q.endUser,
                    'Date': fmtDate(q.date), 
                    'Model': q.model, 'Sales Price': q.salesPrice, 'FAE Price': q.faePrice,
                    'Product Structure': q.productStructure,
                    'REF#': q.ref, 'Desc': q.desc, '_comments': q.comments
                }));
                addSheet("報價列表", quoteData);

                // 4. Contacts
                const contactData = db.contacts.map(c => ({
                    'Agent': c.agent, 'End User': c.endUser, 
                    'Name': c.name, 'Email': c.email, 'Position': c.position,
                    'Phone': c.phone, 'Address': c.address, 'Remark': c.remark, '_comments': c.comments
                }));
                addSheet("聯絡人清單", contactData);

                // 5. Codes
                const codeData = db.codes.map(c => ({
                    'Agent': c.agent, 'End User': c.endUser, 'Code': c.code,
                    'Pricing': c.pricing, 'Logistics': c.logistics, 'Remark': c.remark, '_comments': c.comments
                }));
                addSheet("客戶代碼與行為", codeData);

                // 檔名：LIST(業務管理表)_"使用者名稱"__YYYYMMDD_HHMM.xlsx
                XLSX.writeFile(wb, `LIST(業務管理表)_${safeName}_${dateStr}.xlsx`, { cellStyles: true });
            } else {
                // Daily 邏輯
                const today = new Date();
                const limitDate = new Date();
                limitDate.setDate(today.getDate() - 10);
                limitDate.setHours(0,0,0,0);

                const data = db.tasks.filter(t => {
                    if (!t.completed) return false;
                    if (timeRange === 10) {
                        const dStr = t.completedDate || t.trackDate;
                        if (!dStr) return false;
                        const d = new Date(dStr);
                        d.setHours(0,0,0,0);
                        return d >= limitDate;
                    }
                    return true;
                })
                .sort((a,b) => {
                    const dA = a.completedDate || a.trackDate || '9999-99-99';
                    const dB = b.completedDate || b.trackDate || '9999-99-99';
                    return new Date(dA) - new Date(dB);
                })
                .map(t => {
                    const ag = t.agent || '';
                    const eu = t.endUser || '';
                    let custStr = '';
                    if(ag && eu) custStr = `${ag} / ${eu}`;
                    else custStr = ag || eu || '';
                    return {
                        '客戶': custStr, 
                        '日期': fmtDate(t.completedDate || t.trackDate), 
                        '議題': '', 
                        '業務事項': `${t.taskType} / ${t.model||''}`, 
                        '進度狀況': t.desc, 
                        '備註': t.docNum
                    };
                });
                
                if (data.length === 0) {
                    alert('在此時間範圍內，沒有已完成的任務可匯出');
                    return;
                }

                const ws = XLSX.utils.json_to_sheet(data);
                processSheet(ws, data);
                XLSX.utils.book_append_sheet(wb, ws, "進度狀況");

                // 檔名：Daily(業務進度狀況)_"使用者名稱"__YYYYMMDD_HHMM.xlsx
                XLSX.writeFile(wb, `Daily(業務進度狀況)_${safeName}_${dateStr}.xlsx`, { cellStyles: true });
            }
        }
        
        function backupData() {
             // 1. 取得時間 YYYYMMDD_HHMM
             const now = new Date();
             const YYYY = now.getFullYear();
             const MM = String(now.getMonth() + 1).padStart(2, '0');
             const DD = String(now.getDate()).padStart(2, '0');
             const HH = String(now.getHours()).padStart(2, '0');
             const MIN = String(now.getMinutes()).padStart(2, '0');
             const dateStr = `${YYYY}${MM}${DD}_${HH}${MIN}`;
             // 2. 取得當前使用者名稱 (並處理檔名安全字元)
             const currentP = profileMeta.list.find(p => p.id === profileMeta.currentId) || { name: 'User' };
             const safeName = currentP.name.replace(/[\s\/\\]/g, '_'); // 將空白或斜線轉為底線

             // [修正] 建立備份 payload，將 db 與 profileMeta 一併打包
             const payload = {
                 ...db,
                 profileMeta: profileMeta
             };

             const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(payload));
             const node = document.createElement('a'); node.href = dataStr; 
             
             // 3. 命名格式：BusinessFlow_"使用者名稱"_YYYYMMDD_HHMM
             node.download = `BusinessFlow_${safeName}_${dateStr}.json`;
             node.click();
        }

        function restoreData(e) {
            const file = e.target.files[0];
            if (!file) return;

            const r = new FileReader();
            r.onload = (ev) => {
                try {
                    const loadedData = JSON.parse(ev.target.result);

                    // [修正] 優先還原 User Profile (若備份檔中有包含)
                    if (loadedData.profileMeta) {
                        profileMeta = loadedData.profileMeta;
                        saveProfileMeta(); // 寫入 LocalStorage (workflow_profiles_meta)
                        renderProfileUI(); // 立即更新介面 (頭像/名稱/下拉選單)
                        
                        // 從 loadedData 中移除 profileMeta，剩下的就是純 db 資料
                        delete loadedData.profileMeta;
                    }

                    const loadedDb = loadedData;

                    // 簡單的格式檢查
                    if (!loadedDb.projects && !loadedDb.masterList) {
                        alert("檔案格式不正確，找不到必要的資料結構。");
                        return;
                    }

                    // 更新記憶體中的 DB
                    db = loadedDb;
                    // 確保資料結構完整 (避免舊版備份缺少新欄位)
                    if (!db.masterList) db.masterList = [];
                    // 其他陣列若需補齊可在此加入，例如 codes, contacts 等

                    // 存檔 (這裡會自動存入當前 User Profile 的 Key)
                    saveToLocal();
                    // 重置 Undo 歷史，避免還原後又 Undo 到空狀態
                    historyStack = [];
                    redoStack = [];
                    lastSavedState = JSON.stringify(db);

                    // 關鍵修正：不執行 location.reload()，而是直接更新畫面
                    // 這樣可以避免頁面重整後，因為初始化時機問題導致資料看似沒載入
                    renderNav();
                    switchView(currentView);
                    autoCheckShipment();
                    
                    // [修正] 溫暖的歡迎訊息 (顯示 3 秒)
                    const currentName = document.getElementById('displayUserName').value || '使用者';
                    showToast(`還原成功✅\n歡迎回來，<b>${currentName}！</b>`, 3000);
                } catch (err) {
                    console.error(err);
                    alert("還原失敗：無法解析 JSON 檔案。");
                } finally {
                    // 清空 input，允許連續上傳同一個檔案 (若需要)
                    e.target.value = '';
                }
            };
            r.readAsText(file);
        }

        // 新增：報價單匯出相關邏輯
        function openQuoteExportModal() {
            // 修正：依賴 exportQuoteId 而非 selectedIds
            if (!exportQuoteId) {
                alert("請先勾選一筆資料");
                return;
            }
            const item = db.quotes.find(q => q.id === exportQuoteId);
            if (!item) return;

            // 自動計算下個月日期 (格式 DD-Month縮寫-YYYY)
            const d = new Date();
            d.setMonth(d.getMonth() + 1);
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const dateStr = `${d.getDate().toString().padStart(2,'0')}-${months[d.getMonth()]}-${d.getFullYear()}`;

            // 填入欄位
            document.getElementById('qe_model').value = item.model || '';
            document.getElementById('qe_project').value = item.project || '';
            document.getElementById('qe_price').value = item.salesPrice || '';
            document.getElementById('qe_date').value = dateStr;
            document.getElementById('qe_incoterm').value = 'FCA';
            document.getElementById('qe_country').value = 'Taiwan';
            document.getElementById('qe_struct').value = item.productStructure || '';

            const modal = document.getElementById('quoteExportModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeQuoteExportModal() {
            const modal = document.getElementById('quoteExportModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function confirmExportQuote() {
            // ... (前段省略：變數定義與 Excel 建構邏輯，保持不變) ...
            const model = document.getElementById('qe_model').value;
            const project = document.getElementById('qe_project').value;
            const price = document.getElementById('qe_price').value;
            const date = document.getElementById('qe_date').value;
            const incoterm = document.getElementById('qe_incoterm').value;
            const country = document.getElementById('qe_country').value;
            const struct = document.getElementById('qe_struct').value;

            // ... (中段省略：樣式定義與 ws_data 建構，請保留您上一次修改成功的樣式代碼) ...
            // 為了節省篇幅，此處僅顯示函式尾端的關鍵修正
            
            // --- 寫入 Excel ---
            // (請保留原本的寫入邏輯)
            const colorText = { rgb: "1F497D" };
            const colorBgGray = { rgb: "F2F2F2" };
            const colorBgWhite = { rgb: "FFFFFF" };
            const colorBorderBlue = { rgb: "95B3D7" };
            const colorBorderGray = { rgb: "D9D9D9" };
            const fontBold = { name: "Calibri", sz: 11, color: colorText, bold: true };
            const fontNormal = { name: "Calibri", sz: 11, color: colorText };
            const fontItalic = { name: "Calibri", sz: 11, color: colorText, italic: true };
            const borderThickGray = { style: "thick", color: colorBorderGray };
            const borderThickBlue = { style: "thick", color: colorBorderBlue };
            const borderNone = { style: "none" };

            const ws_data = [
                [{ v: model, s: { font: fontBold, fill: { fgColor: colorBgGray }, alignment: { wrapText: true, vertical: 'top' }, border: { top: borderThickGray, left: borderThickGray, right: borderThickGray, bottom: borderNone } } }],
                [{ v: price, s: { font: fontNormal, fill: { fgColor: colorBgGray }, alignment: { wrapText: true, vertical: 'top' }, border: { top: borderNone, left: borderThickGray, right: borderThickGray, bottom: borderThickBlue } } }],
                [{ v: `(${project})`, s: { font: fontNormal, fill: { fgColor: colorBgGray }, alignment: { wrapText: true, vertical: 'top' }, border: { top: borderNone, left: borderThickGray, right: borderThickGray, bottom: borderNone } } }],
                [{ v: `This quotation has been effective until ${date}\nDelivery term: ${incoterm} ${country}`, s: { font: fontItalic, fill: { fgColor: colorBgGray }, alignment: { wrapText: true, vertical: 'top' }, border: { top: borderNone, left: borderThickGray, right: borderThickGray, bottom: borderThickGray } } }],
                [{ v: `Details:\n${struct}`, s: { font: fontNormal, fill: { fgColor: colorBgWhite }, alignment: { wrapText: true, vertical: 'top' }, border: { top: borderThickGray, left: borderThickGray, right: borderThickGray, bottom: borderThickGray } } }]
            ];

            const ws = XLSX.utils.aoa_to_sheet([]);
            ws['!cols'] = [{ wch: 60 }];
            const countLines = (str) => (str || '').split(/\r\n|\r|\n/).length;
            ws['!rows'] = [{ hpx: 20 }, { hpx: Math.max(24, countLines(price) * 18) }, { hpx: 20 }, { hpx: 40 }, { hpx: Math.max(60, countLines(struct) * 18) }];

            ws['A1'] = ws_data[0][0]; ws['A2'] = ws_data[1][0]; ws['A3'] = ws_data[2][0]; ws['A4'] = ws_data[3][0]; ws['A5'] = ws_data[4][0];
            ws['!ref'] = `A1:A5`;
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Quotation");
            
            // 產生檔名並下載
            const safeModel = (model || 'Export').replace(/[^a-z0-9]/gi, '_');
            XLSX.writeFile(wb, `Quotation_${safeModel}_${date}.xlsx`);
            
            // 1. 關閉彈出視窗
            closeQuoteExportModal();
            
            // 2. 【修正】強制復原 UI 狀態 (不使用 Toggle，改為直接操作)
            isExportQuoteMode = false; // 關閉模式旗標
            exportQuoteId = null;      // 清除選取 ID
            
            const btn = document.getElementById('btnExportQuote');
            if(btn) {
                btn.classList.remove('btn-glow-red'); // 移除閃爍特效
                const span = btn.querySelector('span');
                if(span) span.innerText = '匯出報價單 (Quotation)'; // 恢復按鈕文字
            }
            
            renderCurrentView(); // 重新渲染表格 (移除勾選框)
        }

        // V3.8.2 功能已啟用：Undo/Redo 邏輯已在上方 (Line 441-456) 完整實作
        // 此處移除覆蓋用的預留函式，讓真正的還原/重作功能生效
        /* function triggerUndo() { ... } 
        function triggerRedo() { ... }
        */
        
        


        // ==========================================
        // V3.8 Profile System Logic
        // ==========================================
        function initProfileSystem() {
            const savedMeta = localStorage.getItem(PROFILE_STORAGE_KEY);
            if (savedMeta) {
                try {
                    profileMeta = JSON.parse(savedMeta);
                    // 檢查資料結構是否完整，若不完整則視為損壞
                    if (!profileMeta.list || !Array.isArray(profileMeta.list) || profileMeta.list.length === 0) {
                        throw new Error("Profile structure corrupted");
                    }
                } catch (e) {
                    console.error("設定檔讀取失敗，執行重置:", e);
                    // 發生錯誤時，強制重置為預設值，確保程式不會卡死
                    profileMeta = { 
                        list: [{id: 'default', name: '預設使用者', avatar: null}], 
                        currentId: 'default' 
                    };
                    saveProfileMeta();
                }
            } else {
                // 無資料時的初始化
                profileMeta = { 
                    list: [{id: 'default', name: '預設使用者', avatar: null}], 
                    currentId: 'default' 
                };
                saveProfileMeta();
            }
            renderProfileUI();
        }

        function saveProfileMeta() {
            try {
                localStorage.setItem(PROFILE_STORAGE_KEY, JSON.stringify(profileMeta));
            } catch (e) {
                console.error("儲存失敗", e);
                if (e.name === 'QuotaExceededError') {
                    alert("⚠️ 儲存失敗：瀏覽器儲存空間已滿！\n請刪除舊的設定檔，或嘗試上傳解析度較低的圖片。");
                } else {
                    alert("⚠️ 儲存發生未知錯誤，資料可能未保存。");
                }
            }
        }

        function loadCurrentProfileData() {
            const dbKey = profileMeta.currentId === 'default' ? 
                          DEFAULT_DB_KEY : `workflowDB_profile_${profileMeta.currentId}`;
            
            const saved = localStorage.getItem(dbKey);
            if(saved) {
                db = JSON.parse(saved);
            } else {
                // 若新設定檔無資料，初始化為空
                db = { projects: [], masterList: [], orders: [], tasks: [], quotes: [], contacts: [], codes: [] };
            }
            
            // 確保資料結構完整
            if(!db.masterList) db.masterList = [];
            
            // 重置 View
            renderNav();
            switchView('projects');
            autoCheckShipment();
            
            // 重置 Undo/Redo Stack
            historyStack = [];
            redoStack = [];
            lastSavedState = JSON.stringify(db);
        }

        function renderProfileUI() {
            const currentP = profileMeta.list.find(p => p.id === profileMeta.currentId) || profileMeta.list[0];
            
            // Render Avatar
            const imgEl = document.getElementById('displayAvatar');
            if(currentP.avatar) {
                imgEl.src = currentP.avatar;
            } else {
                // 預設圖片 (文字頭像)
                imgEl.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(currentP.name)}&background=random&color=fff&size=128`;
            }

            // Render Name Input
            document.getElementById('displayUserName').value = currentP.name;

            // Render Dropdown
            const selectEl = document.getElementById('profileSelect');
            selectEl.innerHTML = profileMeta.list.map(p => 
                `<option value="${p.id}" ${p.id === profileMeta.currentId ? 'selected' : ''}>${p.name}</option>`
            ).join('');
        }

        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // 既然圖片不大，我們設定一個合理的安全上限 (例如 500KB)
            // 避免誤傳大圖導致 localStorage 爆掉
            if (file.size > 500 * 1024) {
                alert("為確保系統效能，請上傳小於 500KB 的圖片。\n(您的圖片大小: " + (file.size/1024).toFixed(1) + "KB)");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64 = e.target.result;
                const idx = profileMeta.list.findIndex(p => p.id === profileMeta.currentId);
                
                if (idx !== -1) {
                    profileMeta.list[idx].avatar = base64;
                    
                    // 立即存檔並檢查
                    try {
                        saveProfileMeta();
                        renderProfileUI();
                        // 雙重確認：檢查是否真的寫入成功
                        const check = localStorage.getItem(PROFILE_STORAGE_KEY);
                        if(check && check.length > 100) {
                            showToast("大頭照儲存成功");
                        } else {
                            alert("警示：圖片似乎未能寫入硬碟，請檢查瀏覽器設定。");
                        }
                    } catch (err) {
                        console.error(err);
                        alert("儲存失敗：" + err.message);
                    }
                }
            };
            reader.readAsDataURL(file);
        }

        function handleNameChange(newName) {
            if(!newName.trim()) return;
            const idx = profileMeta.list.findIndex(p => p.id === profileMeta.currentId);
            if (idx !== -1) {
                profileMeta.list[idx].name = newName;
                saveProfileMeta();
                renderProfileUI(); // 更新下拉選單的文字
            }
        }

        function createNewProfile() {
            const name = prompt("請輸入新設定檔名稱：");
            if (name) {
                const newId = 'profile_' + Date.now();
                profileMeta.list.push({ id: newId, name: name, avatar: null });
                profileMeta.currentId = newId; // 切換到新帳號
                saveProfileMeta();
                
                // 切換並載入空資料
                renderProfileUI();
                loadCurrentProfileData();
                showToast(`已建立設定檔: ${name}`);
            }
        }

        function switchProfile(id) {
            if(id === profileMeta.currentId) return;
            // 先儲存當前狀態 (雖然 saveToLocal 會自動存，但保險起見)
            saveToLocal();
            
            profileMeta.currentId = id;
            saveProfileMeta();
            renderProfileUI();
            
            // 顯示載入中... (模擬)
            document.getElementById('contentArea').style.opacity = '0.5';
            setTimeout(() => {
                loadCurrentProfileData();
                document.getElementById('contentArea').style.opacity = '1';
                showToast("已切換使用者");
            }, 200);
        }

        function deleteCurrentProfile() {
            if(profileMeta.list.length <= 1) {
                alert("無法刪除最後一個設定檔");
                return;
            }
            if(!confirm(`確定要刪除當前設定檔 (${document.getElementById('displayUserName').value}) 及其所有資料嗎？此動作無法復原！`)) {
                return;
            }

            const deleteId = profileMeta.currentId;
            const deleteDbKey = deleteId === 'default' ? DEFAULT_DB_KEY : `workflowDB_profile_${deleteId}`;

            // 移除 Meta
            profileMeta.list = profileMeta.list.filter(p => p.id !== deleteId);
            // 切換回預設或第一個
            profileMeta.currentId = profileMeta.list[0].id;
            saveProfileMeta();

            // 移除 LocalStorage 資料
            localStorage.removeItem(deleteDbKey);

            renderProfileUI();
            loadCurrentProfileData();
            showToast("設定檔已刪除");
        }


    </script>
</body>
</html>


